<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>lyyljs`s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="java">
<meta property="og:type" content="website">
<meta property="og:title" content="lyyljs&#96;s blog">
<meta property="og:url" content="http://lyyljs.site/index.html">
<meta property="og:site_name" content="lyyljs&#96;s blog">
<meta property="og:description" content="java">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="lyyljs">
<meta property="article:tag" content="开发者">
<meta property="article:tag" content="程序猿">
<meta property="article:tag" content="程序媛">
<meta property="article:tag" content="编程">
<meta property="article:tag" content="代码">
<meta property="article:tag" content="Developer">
<meta property="article:tag" content="Programmer">
<meta property="article:tag" content="Coder">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="lyyljs`s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">lyyljs`s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://lyyljs.site"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-反向代理解决微信小程序业务域名限制问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/05/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%A7%A3%E5%86%B3%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%B8%9A%E5%8A%A1%E5%9F%9F%E5%90%8D%E9%99%90%E5%88%B6%E9%97%AE%E9%A2%98/" class="article-date">
  <time datetime="2019-06-05T23:29:00.000Z" itemprop="datePublished">2019-06-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/05/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%A7%A3%E5%86%B3%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%B8%9A%E5%8A%A1%E5%9F%9F%E5%90%8D%E9%99%90%E5%88%B6%E9%97%AE%E9%A2%98/">反向代理解决微信小程序业务域名限制问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近项目上有需求需要在小程序中跳转第三方网页，但微信业务域名限制了跳转，当聊到这个问题的时候马上就想到了nginx的反向代理。然后就进行了尝试。</p>
<p>nginx 版本为 1.12-alpine。</p>
<h4 id="nginx配置反向代理"><a href="#nginx配置反向代理" class="headerlink" title="nginx配置反向代理"></a>nginx配置反向代理</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  location ^~ &#x2F;testre&#x2F; &#123;</span><br><span class="line">    proxy_pass https:&#x2F;&#x2F;xxx.com&#x2F;;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在nginx配置中添加代理，将访问 xxx.com 的所有链接代理到自己服务器的 /testre/* 路径下。然后在小程序中访问。</p>
<p>结果： 成功绕过域名限制，但css js 图片等资源加载失败，因为路径匹配不上。如 src=”/js/main.js”，因为匹配不到 /testre/ 路径，所以没有代理上。 </p>
<h4 id="修改响应以代理其它资源"><a href="#修改响应以代理其它资源" class="headerlink" title="修改响应以代理其它资源"></a>修改响应以代理其它资源</h4><p>为了解决这个问题，马上想到是否可以用 lua 在将资源返回到前端前进行内容的修改。但因为项目中使用的 nginx 镜像没有 lua-nginx-module ，我也无法对镜像进行修改，所以另寻它法。</p>
<p>使用 nginx -V 命令查看的时候，虽然没有发现 lua-nginx-module，但看到了 ngx_http_sub_module；该模块可以修改网站响应内容中的字符串达到我的目的。于是修改 nginx 配置文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  location ^~ &#x2F;testre&#x2F; &#123;</span><br><span class="line">    proxy_pass https:&#x2F;&#x2F;xxx.com&#x2F;;</span><br><span class="line">    </span><br><span class="line">    sub_filter_types *;</span><br><span class="line">    sub_filter xxx.com myserver.com&#x2F;testre;</span><br><span class="line">    sub_filter &#39;src&#x3D;&quot;&#x2F;images&#x2F;&#39; &#39;src&#x3D;&quot;&#x2F;testre&#x2F;images&#x2F;&#39;;</span><br><span class="line">    sub_filter &#39;href&#x3D;&quot;&#x2F;css&#x2F;&#39; &#39;href&#x3D;&quot;&#x2F;testre&#x2F;css&#x2F;&#39;;</span><br><span class="line">    sub_filter &#39;src&#x3D;&quot;&#x2F;js&#x2F;&#39; &#39;src&#x3D;&quot;&#x2F;testre&#x2F;js&#x2F;&#39;;</span><br><span class="line">    sub_filter_once off;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后访问，发现没有替换成功；网上搜索了一下发现了原因： xxx.com 开启了 gzip 压缩，而 ngx_http_sub_module 对压缩内容是匹配不到相应字符串的，于是加上请求头 Accept-Encoding “”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  location ^~ &#x2F;testre&#x2F; &#123;</span><br><span class="line">    proxy_set_header Accept-Encoding &quot;&quot;;</span><br><span class="line">    proxy_pass https:&#x2F;&#x2F;xxx.com&#x2F;;</span><br><span class="line">    </span><br><span class="line">    sub_filter_types *;</span><br><span class="line">    sub_filter xxx.com myserver.com&#x2F;testre;</span><br><span class="line">    sub_filter &#39;src&#x3D;&quot;&#x2F;images&#x2F;&#39; &#39;src&#x3D;&quot;&#x2F;testre&#x2F;images&#x2F;&#39;;</span><br><span class="line">    sub_filter &#39;href&#x3D;&quot;&#x2F;css&#x2F;&#39; &#39;href&#x3D;&quot;&#x2F;testre&#x2F;css&#x2F;&#39;;</span><br><span class="line">    sub_filter &#39;src&#x3D;&quot;&#x2F;js&#x2F;&#39; &#39;src&#x3D;&quot;&#x2F;testre&#x2F;js&#x2F;&#39;;</span><br><span class="line">    sub_filter_once off;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果： 页面大部分资源加载成功，还是有小部分资源加载失败。</p>
<p>查看这些加载失败的资源，发现是在 css 内部定义的，并且其 url 由 url(../ 变为了 url(../testre/ 。继续修改配置文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  location ^~ &#x2F;testre&#x2F; &#123;</span><br><span class="line">    proxy_set_header Accept-Encoding &quot;&quot;;</span><br><span class="line">    proxy_pass https:&#x2F;&#x2F;xxx.com&#x2F;;</span><br><span class="line">    </span><br><span class="line">    sub_filter_types *;</span><br><span class="line">    sub_filter xxx.com myserver.com&#x2F;testre;</span><br><span class="line">    sub_filter &#39;src&#x3D;&quot;&#x2F;images&#x2F;&#39; &#39;src&#x3D;&quot;&#x2F;testre&#x2F;images&#x2F;&#39;;</span><br><span class="line">    sub_filter &#39;href&#x3D;&quot;&#x2F;css&#x2F;&#39; &#39;href&#x3D;&quot;&#x2F;testre&#x2F;css&#x2F;&#39;;</span><br><span class="line">    sub_filter &#39;src&#x3D;&quot;&#x2F;js&#x2F;&#39; &#39;src&#x3D;&quot;&#x2F;testre&#x2F;js&#x2F;&#39;;</span><br><span class="line">    sub_filter url(..&#x2F;testre&#x2F; url(..&#x2F;;</span><br><span class="line">    sub_filter_once off;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果： 未替换成功。猜测还是 gzip 的原因。</p>
<p>在网上找到一个方法，反代理自身，利用 gunzip 模块先解压，然后再进行替换。修改配置文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen unix:&#x2F;var&#x2F;run&#x2F;nginx-gunzip.sock;</span><br><span class="line">  location &#x2F; &#123;</span><br><span class="line">    proxy_set_header Accept-Encoding gzip;</span><br><span class="line">    proxy_pass https:&#x2F;&#x2F;xxx.com&#x2F;;</span><br><span class="line">    gunzip on;</span><br><span class="line">    access_log off;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  location ^~ &#x2F;testre&#x2F; &#123;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;unix:&#x2F;var&#x2F;run&#x2F;nginx-gunzip.sock:https:&#x2F;&#x2F;xxx.com&#x2F;;</span><br><span class="line">    </span><br><span class="line">    sub_filter_types *;</span><br><span class="line">    sub_filter xxx.com myserver.com&#x2F;testre;</span><br><span class="line">    sub_filter &#39;src&#x3D;&quot;&#x2F;images&#x2F;&#39; &#39;src&#x3D;&quot;&#x2F;testre&#x2F;images&#x2F;&#39;;</span><br><span class="line">    sub_filter &#39;href&#x3D;&quot;&#x2F;css&#x2F;&#39; &#39;href&#x3D;&quot;&#x2F;testre&#x2F;css&#x2F;&#39;;</span><br><span class="line">    sub_filter &#39;src&#x3D;&quot;&#x2F;js&#x2F;&#39; &#39;src&#x3D;&quot;&#x2F;testre&#x2F;js&#x2F;&#39;;</span><br><span class="line">    sub_filter url(..&#x2F;testre&#x2F; url(..&#x2F;;</span><br><span class="line">    sub_filter_once off;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再访问结果即ok了。</p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><ul>
<li><p><a href="https://segmentfault.com/q/1010000007239595/a-1020000007242960" target="_blank" rel="noopener">在Nginx+Lua的环境下，怎样在响应数据返回前，替换部分数据？</a></p>
</li>
<li><p><a href="http://nginx.org/en/docs/http/ngx_http_sub_module.html" target="_blank" rel="noopener">Module ngx_http_sub_module</a></p>
</li>
<li><p><a href="https://www.v2ex.com/t/234923" target="_blank" rel="noopener">Nginx 反代 Gzip 内容时， sub_filter 等 content filter 无效的另一种解决</a></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyyljs.site/2019/06/05/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%A7%A3%E5%86%B3%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%B8%9A%E5%8A%A1%E5%9F%9F%E5%90%8D%E9%99%90%E5%88%B6%E9%97%AE%E9%A2%98/" data-id="ckaqogbv3001w43o62ce1e6y1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Stream-编程背后" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/13/Stream-%E7%BC%96%E7%A8%8B%E8%83%8C%E5%90%8E/" class="article-date">
  <time datetime="2019-05-13T22:14:00.000Z" itemprop="datePublished">2019-05-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/13/Stream-%E7%BC%96%E7%A8%8B%E8%83%8C%E5%90%8E/">Stream实现原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="Stream-Api"><a href="#Stream-Api" class="headerlink" title="Stream Api"></a>Stream Api</h4><p>首先回顾下 Stream Api 的操作分类：</p>
<table>
<thead>
<tr>
<th align="center">操作分类</th>
<th align="center">子分类</th>
<th align="center">操作</th>
</tr>
</thead>
<tbody><tr>
<td align="center"></td>
<td align="center">无状态</td>
<td align="center">unordered filter map mapTo…</td>
</tr>
<tr>
<td align="center">中间操作</td>
<td align="center"></td>
<td align="center">flatMap flatMapTo… peek</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">有状态</td>
<td align="center">distinct sorted limit skip</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">非短路操作</td>
<td align="center">forEach forEachOrdered toArray</td>
</tr>
<tr>
<td align="center">终结操作</td>
<td align="center"></td>
<td align="center">reduce collect max min count</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">短路操作</td>
<td align="center">anyMatch allMatch noneMatch</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">findFirst findAny</td>
</tr>
</tbody></table>
<p>前文有提到 Stream操作分为中间操作和终结操作，其中中间操作不会触发实际动作，仅标记状态；终结操作才会触发实际计算动作。<br>中间操作又分为无状态（Stateless）和有状态(Stateful)，有无状态是指元素间是否相互影响，如 sort 是有状态操作，<br>读取完全部元素前不能确定结果；终结操作又分为非短路操作和短路操作，短路操作是指不需要处理全部元素即可返回结果，如 findFirst。</p>
<h4 id="简单的实现方式"><a href="#简单的实现方式" class="headerlink" title="简单的实现方式"></a>简单的实现方式</h4><p>接下来看个示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Stream.of(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;four&quot;)</span><br><span class="line">                .filter(e -&gt; e.length() &gt; 3)</span><br><span class="line">                .map(String::toUpperCase)</span><br><span class="line">                .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p>该代码将字符串序列过滤，找出其中长度大于三的字符串转为大写，并收集为List。我们很容易想到一种实现方式，即每个函数都执行一次迭代，并将处理的数据<br>保存在中间容器中。用代码描述如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; do filter</span><br><span class="line">List&lt;String&gt; filterList &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">for (String s: source)&#123;</span><br><span class="line">  if (s.length &gt; 3)&#123;</span><br><span class="line">    filterList.add(source);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; do map</span><br><span class="line">List&lt;String&gt; mapList &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">for (String s: filterList)&#123;</span><br><span class="line">  mapList.add(s.toUpperCase());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; do collect</span><br><span class="line">List&lt;String&gt; collectList &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">collectList.addAll(mapList);</span><br></pre></td></tr></table></figure>

<p>显然，这种实现虽然简单，但多次迭代既浪费时间，存储中间结果又浪费空间，效率极低。在我们自己实现时，自然会采用以下方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; collectList &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">for (String s: source)&#123;</span><br><span class="line">  if (s.length &gt; 3)&#123; &#x2F;&#x2F; filter(), 获取长度大于3的字符串</span><br><span class="line">    String upperStr &#x3D; s.toUpperCase(); &#x2F;&#x2F; map(), 转为大写字符串</span><br><span class="line">    collectList.add(upperStr); &#x2F;&#x2F; collect(), 收集结果</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>采用这种方式我们既减少了迭代次数，也避免存储中间结果。这就是pipeline的目标结果了。当知道操作目标时，就可以将操作进行叠加到单次迭代来实现 Stream Api了。这也是为什么对操作的分类多且详细。</p>
<h4 id="Stream-Pipeline"><a href="#Stream-Pipeline" class="headerlink" title="Stream Pipeline"></a>Stream Pipeline</h4><p>从上面我们可以得到解决方案的思路，我们需要在调用终结操作前，先将依序中间操作记录下来，然后在调用终结操作时将中间操作叠加在一起并在一次迭代中将所有操作执行。<br>即：</p>
<ol>
<li>记录中间操作</li>
<li>叠加操作</li>
<li>执行操作</li>
<li>保存结果</li>
</ol>
<h5 id="记录操作"><a href="#记录操作" class="headerlink" title="记录操作"></a>记录操作</h5><p>Stream中使用 Stage 这个术语来描述一组完整的操作，并使用示例化后的 PipelineHelper 来代表 Stage。将这些 Stage 按序串联起来，就够成了整个流水线。</p>
<p>与之相关的接口与类如下图所示。</p>
<p><img src="/images/jdk/pipeline_classes.png" alt=""></p>
<p>图中 DoublePipeline LongPipeline 与 IntPipeline 是专门处理对应基本类型的流水线，这里主要关注 ReferencePipeline。</p>
<p><img src="/images/jdk/ReferencePipeline_Inner.png" alt=""></p>
<p>Head, StatefulOp, StatelessOp 是 ReferencePipeline 的子类。其中 Head 用于表示第一个 Stage，如调用产生流的一些方法如Collections.stream()方法所产生的 Stage，因此该 Stage不会包含任何操作； StatefulOp 和 StatelessOp 分别代表有无状态的 Stage，对应有无状态的中间操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">____________       ______ ----&gt; ____________ ----&gt; ___________</span><br><span class="line">|Collection|       |Head|      |StatelessOp|       |StatefulOp|</span><br><span class="line">------------       ------ &lt;---  ------------ &lt;---  -----------</span><br><span class="line">data source ————&gt; stage0 ————&gt;  stage1    ————&gt;    stage2</span><br><span class="line">           stream          map              sort</span><br></pre></td></tr></table></figure>

<p>上图所示 Pipeline，由Collection.stream() 产生 Head，然后调用一系列的中间操作不断产生 Stream。这些 Stream 对象以双向链表的形式组织在一起，构成整个流水线，由于每个 Stage 都记录了前一个 Stage 和本次的操作以及回调函数，依靠这种结构就能建立起对数据源的所有操作。这就是 Stream 记录操作的方式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 将 stage 添加到已有 pipeline 建立链表</span><br><span class="line">AbstractPipeline(AbstractPipeline&lt;?, E_IN, ?&gt; previousStage, int opFlags) &#123;</span><br><span class="line">    if (previousStage.linkedOrConsumed)</span><br><span class="line">        throw new IllegalStateException(MSG_STREAM_LINKED);</span><br><span class="line">    previousStage.linkedOrConsumed &#x3D; true;</span><br><span class="line">    previousStage.nextStage &#x3D; this;</span><br><span class="line"></span><br><span class="line">    this.previousStage &#x3D; previousStage;</span><br><span class="line">    this.sourceOrOpFlags &#x3D; opFlags &amp; StreamOpFlag.OP_MASK;</span><br><span class="line">    this.combinedFlags &#x3D; StreamOpFlag.combineOpFlags(opFlags, previousStage.combinedFlags);</span><br><span class="line">    this.sourceStage &#x3D; previousStage.sourceStage;</span><br><span class="line">    if (opIsStateful())</span><br><span class="line">        sourceStage.sourceAnyStateful &#x3D; true;</span><br><span class="line">    this.depth &#x3D; previousStage.depth + 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="叠加操作"><a href="#叠加操作" class="headerlink" title="叠加操作"></a>叠加操作</h5><p>直觉上，操作叠加非常简单，就是从 Head 开始依次执行每一次操作。但事实上，Stage 之间并不知道互相执行了什么样的操作，这使得需要有方法来协调相邻 Stage 之间的调用关系。</p>
<p>Sink 接口用于解决这个问题，</p>
<p><img src="/images/jdk/sink_uml.png" alt=""></p>
<ul>
<li><p>begin 开始遍历元素之前调用该方法，通知Sink做好准备。</p>
</li>
<li><p>end 所有元素遍历完成之后调用，通知Sink没有更多的元素了。</p>
</li>
<li><p>cancellationRequested 是否可以结束操作，可以让短路操作尽早结束。</p>
</li>
<li><p>accept 遍历元素时调用，接受一个待处理元素，并对元素进行处理。Stage把自己包含的操作和回调方法封装到该方法里，前一个Stage只需要调用当前Stage.accept方法就行了。</p>
</li>
</ul>
<p>经过 Sink 封装后，Stage之间就可以方便调用，仅需调用 accept 方法而不必知道其内部实现。对于 StatefulOp 来说，需要实现 begin 和 end 方法。对于短路操作来说，还需实现 cancellationRequested 方法来尽快返回。Sink 的四个接口方法常常相互协作，共同完成计算任务。实际上 Stream API 内部实现的的本质，就是如何重载 Sink 的这四个接口方法。在经过包装后，执行时只需要从流水线的 Head 开始对数据源依次调用每个 Stage 对应的 Sink 的 begin, accept, cancellationRequested, end 方法就可以了。</p>
<p>Sink.accept 方法通常首先使用当前 Sink 包装的回调函数处理元素，然后再将结果传递给流水线下游的 Sink。来看下 ReferencePipeline 对 filter 方法的实现观察这一流程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Stream.filter(predicate)会产生新的Stream</span><br><span class="line">public final Stream&lt;P_OUT&gt; filter(Predicate&lt;? super P_OUT&gt; predicate) &#123;</span><br><span class="line">    Objects.requireNonNull(predicate);</span><br><span class="line">    return new StatelessOp&lt;P_OUT, P_OUT&gt;(this, StreamShape.REFERENCE,</span><br><span class="line">                                 StreamOpFlag.NOT_SIZED) &#123;</span><br><span class="line">        @Override &#x2F;&#x2F;opWripSink()方法返回由回调函数包装而成Sink</span><br><span class="line">        Sink&lt;P_OUT&gt; opWrapSink(int flags, Sink&lt;P_OUT&gt; sink) &#123;</span><br><span class="line">            return new Sink.ChainedReference&lt;P_OUT, P_OUT&gt;(sink) &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void begin(long size) &#123;</span><br><span class="line">                    downstream.begin(-1); &#x2F;&#x2F; 因不知道推到下流的元素数量，使用-1代表未知或无限</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void accept(P_OUT u) &#123;</span><br><span class="line">                    if (predicate.test(u))&#x2F;&#x2F; 1. 使用当前Sink包装的回调函数predicate处理u</span><br><span class="line">                        downstream.accept(u);&#x2F;&#x2F; 2. 将处理结果传递给流水线下游的Sink</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面将回调函数predicate包装到一个Sink当中。由于 filter 是一个无状态的中间操作，所以 filter 方法返回了一个 StatelessOp 内部类对象（一个新的Stream），调用这个新 Stream 的 opWripSink() 方法将得到一个包装了当前回调函数的Sink。</p>
<p>再来看下 SortedOps 对 refences sorted 的实现，因 sorted 在遍历完全部元素不知道结果，所以会复杂一些。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">private static final class RefSortingSink&lt;T&gt; extends AbstractRefSortingSink&lt;T&gt; &#123;</span><br><span class="line">       private ArrayList&lt;T&gt; list;&#x2F;&#x2F; 存放用于排序的元素</span><br><span class="line"></span><br><span class="line">       RefSortingSink(Sink&lt;? super T&gt; sink, Comparator&lt;? super T&gt; comparator) &#123;</span><br><span class="line">           super(sink, comparator);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void begin(long size) &#123;</span><br><span class="line">           &#x2F;&#x2F; MAX_ARRAY_SIZE &#x3D; Integer.MAX_VALUE - 8 是最大可收集元素个数</span><br><span class="line">           if (size &gt;&#x3D; Nodes.MAX_ARRAY_SIZE)</span><br><span class="line">               throw new IllegalArgumentException(Nodes.BAD_SIZE);</span><br><span class="line">           &#x2F;&#x2F; 1.初始化 list</span><br><span class="line">           list &#x3D; (size &gt;&#x3D; 0) ? new ArrayList&lt;T&gt;((int) size) : new ArrayList&lt;T&gt;();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void end() &#123;</span><br><span class="line">           &#x2F;&#x2F; 3.只有元素全部接收之后才能开始排序</span><br><span class="line">           list.sort(comparator);</span><br><span class="line">           &#x2F;&#x2F; 传递给下游元素个数</span><br><span class="line">           downstream.begin(list.size());</span><br><span class="line">           &#x2F;&#x2F; 如果下游 Sink 不包含短路操作，则传递给下游</span><br><span class="line">           if (!cancellationWasRequested) &#123;</span><br><span class="line">               list.forEach(downstream::accept); &#x2F;&#x2F;  传递元素</span><br><span class="line">           &#125;</span><br><span class="line">           else &#123;</span><br><span class="line">           &#x2F;&#x2F; 如果下游包含短路操作，则每次先询问是否短路，再传递元素</span><br><span class="line">               for (T t : list) &#123;</span><br><span class="line">                   if (downstream.cancellationRequested()) break;</span><br><span class="line">                   downstream.accept(t); &#x2F;&#x2F; 传递元素</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           downstream.end();</span><br><span class="line">           list &#x3D; null;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void accept(T t) &#123;</span><br><span class="line">           list.add(t); &#x2F;&#x2F; 2. 使用当前Sink包装动作处理t，只是简单的将元素添加到中间列表当中</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>上述代码完美的展现了Sink的四个接口方法是如何协同工作的：</p>
<ol>
<li>首先 begin 方法告诉 Sink 参与排序的元素个数，方便确定中间结果容器的的大小；</li>
<li>之后通过 accept 方法将元素添加到中间结果当中，最终执行时调用者会不断调用该方法，直到遍历所有元素；</li>
<li>最后 end 方法告诉 Sink 所有元素遍历完毕，启动排序，排序完成后将结果传递给下游的 Sink ；</li>
<li>如果下游的 Sink 是短路操作，则将结果传递给下游时会不断询问下游cancellationRequested 是否可以结束处理。</li>
</ol>
<h5 id="执行操作"><a href="#执行操作" class="headerlink" title="执行操作"></a>执行操作</h5><p>叠加操作完成后，我们只需要执行操作了。如之前所说，中间操作不会触发执行，只有终结操作会触发执行。一旦调用终结操作，就会触发整个 pipeline 的执行。</p>
<p>终结操作不会创建新的 stream ，亦即不会创建 stage 。结束操作会创建一个包装本身的 Sink ，这也是最后一个 Sink ，不会继续将元素传递给下游，仅对元素进行处理。</p>
<p>AbstractPipeline.opWrapSink(int flags, Sink<P_OUT> sink) 方法返回一个新的包含了当前 Stage 代表的操作以及能够将结果传递给 downstream 的 Sink 对象，示例可见叠加操作一节中 filter 的源码。使用 opWrapSink 可以将当前操作与下游 Sink 结合成新 Sink 。如果从终结操作的 Sink 开始至 Head 调用该方法，则会形成一个包含了所有操作的 Sink, 这就是 AbstractPipeline.wrapSink 方法，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 从下游回溯不断调用 opWrapSink</span><br><span class="line">   &#x2F;&#x2F; 如果传入参数 sink 是终结操作的 Sink, 则会得到一个含所有操作的 sink</span><br><span class="line">final &lt;P_IN&gt; Sink&lt;P_IN&gt; wrapSink(Sink&lt;E_OUT&gt; sink) &#123;</span><br><span class="line">       Objects.requireNonNull(sink);</span><br><span class="line"></span><br><span class="line">       for ( @SuppressWarnings(&quot;rawtypes&quot;) AbstractPipeline p&#x3D;AbstractPipeline.this; p.depth &gt; 0; p&#x3D;p.previousStage) &#123;</span><br><span class="line">           sink &#x3D; p.opWrapSink(p.previousStage.combinedFlags, sink);</span><br><span class="line">       &#125;</span><br><span class="line">       return (Sink&lt;P_IN&gt;) sink;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>现在流水线上所有操作都被包含到该 Sink 中，仅需执行该 Sink </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; AbstractPipeline</span><br><span class="line">   &#x2F;&#x2F; 对spliterator代表的数据执行wrappedSink代表的操作</span><br><span class="line">   &#x2F;&#x2F; Spliterator 可认为是可拆分，可批量迭代的Iterator</span><br><span class="line">final &lt;P_IN&gt; void copyInto(Sink&lt;P_IN&gt; wrappedSink, Spliterator&lt;P_IN&gt; spliterator) &#123;</span><br><span class="line">       Objects.requireNonNull(wrappedSink);</span><br><span class="line"></span><br><span class="line">       if (!StreamOpFlag.SHORT_CIRCUIT.isKnown(getStreamAndOpFlags())) &#123;</span><br><span class="line">           &#x2F;&#x2F; 通知开始遍历</span><br><span class="line">           wrappedSink.begin(spliterator.getExactSizeIfKnown());</span><br><span class="line">           &#x2F;&#x2F; 执行迭代</span><br><span class="line">           spliterator.forEachRemaining(wrappedSink);</span><br><span class="line">           &#x2F;&#x2F; 通知结束遍历</span><br><span class="line">           wrappedSink.end();</span><br><span class="line">       &#125;</span><br><span class="line">       else &#123;</span><br><span class="line">           &#x2F;&#x2F; 带短路操作的使用该方法</span><br><span class="line">           copyIntoWithCancel(wrappedSink, spliterator);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h5 id="保存结果"><a href="#保存结果" class="headerlink" title="保存结果"></a>保存结果</h5><p>所有操作执行完成后，我们需要知道执行结果保存在哪。除开无返回结果的终结操作（如forEach，我们需要的是它的Side effects），将带返回结果的操作列出如下：</p>
<table>
<thead>
<tr>
<th align="center">返回类型</th>
<th align="center">终结操作</th>
</tr>
</thead>
<tbody><tr>
<td align="center">boolean</td>
<td align="center">anyMatch allMatch noneMatch</td>
</tr>
<tr>
<td align="center">Optional</td>
<td align="center">findFirst findAny</td>
</tr>
<tr>
<td align="center">归约结果</td>
<td align="center">reduce collect max min count</td>
</tr>
<tr>
<td align="center">数组</td>
<td align="center">toArray</td>
</tr>
</tbody></table>
<ol>
<li>对于表中返回boolean或者Optional的操作的操作，由于只返回一个值，只需要在对应的Sink中记录这个值，等到执行结束时返回就可以了。</li>
<li>对于归约操作，最终结果放在用户调用时指定的容器中（容器类型通过收集器指定）。collect, reduce, max, min都是归约操作，虽然 max 和 min 也是返回一个Optional，但事实上底层是通过调用reduce方法实现的。同理 count 同样是调用的reduce。</li>
<li>对于返回是数组的情况，毫无疑问的结果会放在数组当中。这么说当然是对的，但在最终返回数组之前，结果其实是存储在一种叫做Node的数据结构中的。Node是一种多叉树结构，元素存储在树的叶子当中，并且一个叶子节点可以存放多个元素。这样做是为了并行执行方便。</li>
</ol>
<h4 id="并行计算"><a href="#并行计算" class="headerlink" title="并行计算"></a>并行计算</h4><p>Stream 还有一大优势，即可简单的利用多核优势进行并行计算。只使用steam.parallel方法或Collection.parallelStream即可创建一条并行流。</p>
<p>为了找出整个流程，首先我们找到执行终结操作的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; AbstractPipeline</span><br><span class="line">   &#x2F;&#x2F; 执行终结操作</span><br><span class="line">final &lt;R&gt; R evaluate(TerminalOp&lt;E_OUT, R&gt; terminalOp) &#123;</span><br><span class="line">       assert getOutputShape() &#x3D;&#x3D; terminalOp.inputShape();</span><br><span class="line">       if (linkedOrConsumed)</span><br><span class="line">           throw new IllegalStateException(MSG_STREAM_LINKED);</span><br><span class="line">       linkedOrConsumed &#x3D; true;</span><br><span class="line"></span><br><span class="line">       return isParallel()</span><br><span class="line">              ? terminalOp.evaluateParallel(this, sourceSpliterator(terminalOp.getOpFlags()))</span><br><span class="line">              : terminalOp.evaluateSequential(this, sourceSpliterator(terminalOp.getOpFlags()));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这里判断了是否为并行，并行则使用并行执行方法。evaluateParallel是TerminalOp接口的方法，有多个实现，可到 FindOps 查看下该方法的一种实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">      public &lt;P_IN&gt; O evaluateParallel(PipelineHelper&lt;T&gt; helper,</span><br><span class="line">                                       Spliterator&lt;P_IN&gt; spliterator) &#123;</span><br><span class="line">          return new FindTask&lt;&gt;(this, helper, spliterator).invoke();</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>这里生成了一个FindTask并执行。</p>
<p>其他ReduceOps，MatchOps等类似，都是执行了对应Task，现对相关Task整理为图列出。</p>
<p><img src="/images/jdk/SteamTasksUML.png" alt=""></p>
<p>所有的Task都是ForkJoinTask的子类，从此也可以看出Stream的并行是基于ForkJoin实现的。</p>
<p>查看AbstractTask的compute方法，看是如何进行并行计算的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public void compute() &#123;</span><br><span class="line">    Spliterator&lt;P_IN&gt; rs &#x3D; spliterator, ls; &#x2F;&#x2F; right, left spliterators</span><br><span class="line">    &#x2F;&#x2F;预估这个分片中的数据量</span><br><span class="line">    long sizeEstimate &#x3D; rs.estimateSize();</span><br><span class="line">    &#x2F;&#x2F;获取阈值</span><br><span class="line">    long sizeThreshold &#x3D; getTargetSize(sizeEstimate);</span><br><span class="line">    boolean forkRight &#x3D; false;</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;) K task &#x3D; (K) this;</span><br><span class="line">    &#x2F;&#x2F;根据预估的数据量获取最小处理单元的大小阈值，即当数据量已经小于这个阈值的时候进行计算，否则进行fork 将任务划分成更小的数据块</span><br><span class="line">    while (sizeEstimate &gt; sizeThreshold &amp;&amp; (ls &#x3D; rs.trySplit()) !&#x3D; null) &#123;</span><br><span class="line">        K leftChild, rightChild, taskToFork;</span><br><span class="line">        &#x2F;&#x2F;分别将左右分片的任务创建为新的Task，并且将当前的任务关联为两个新任务的父级任务</span><br><span class="line">        task.leftChild  &#x3D; leftChild &#x3D; task.makeChild(ls);</span><br><span class="line">        task.rightChild &#x3D; rightChild &#x3D; task.makeChild(rs);</span><br><span class="line">        &#x2F;&#x2F;先后对左右子节点的任务进行fork，对另外的分区进行分解。同时设定pending 为1，这代表一个task 实际上只会有一个等待的子节点（被fork）</span><br><span class="line">        task.setPendingCount(1);</span><br><span class="line">        if (forkRight) &#123;</span><br><span class="line">            forkRight &#x3D; false;</span><br><span class="line">            rs &#x3D; ls;</span><br><span class="line">            task &#x3D; leftChild;</span><br><span class="line">            taskToFork &#x3D; rightChild;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            forkRight &#x3D; true;</span><br><span class="line">            task &#x3D; rightChild;</span><br><span class="line">            taskToFork &#x3D; leftChild;</span><br><span class="line">        &#125;</span><br><span class="line">        taskToFork.fork();</span><br><span class="line">        sizeEstimate &#x3D; rs.estimateSize();</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;当任务已经分解到足够小的时候退出循环，尝试进行结束。调用子类实现的doLeaf方法，完成最小计算单元的计算任务，并设置到当前任务的localResult中</span><br><span class="line">    task.setLocalResult(task.doLeaf());</span><br><span class="line">    &#x2F;&#x2F;调用tryComplete 方法进行最终任务的扫尾工作，如果该任务pending 值不等于0，则原子的减1，如果已经等于0，说明任务都已经完成，则调用onCompletion 回调，如果该任务是叶子任务，则直接销毁中间数据结束；如果是中间节点会将左右子节点的结果进行合并</span><br><span class="line">    &#x2F;&#x2F;检查如果这个任务已经没有父级任务了，则将该任务置为正常结束，如果还有则尝试递归的去调用父级节点的onCompletion回调，逐级进行任务的合并。</span><br><span class="line">    task.tryComplete();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyyljs.site/2019/05/13/Stream-%E7%BC%96%E7%A8%8B%E8%83%8C%E5%90%8E/" data-id="ckaqogbu0000n43o604fja9zr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/stream/" rel="tag">stream</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-jdk8函数式编程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/04/jdk8%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" class="article-date">
  <time datetime="2019-05-04T15:41:00.000Z" itemprop="datePublished">2019-05-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/04/jdk8%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/">jdk8函数式编程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="Lambda表达式"><a href="#Lambda表达式" class="headerlink" title="Lambda表达式"></a>Lambda表达式</h4><p>Lambda表达式允许我们将函数当成参数传递给某个方法，或者把代码本身当作数据处理。这一特性在许多语言都有支持，如pyhton, js等。Jdk1.8开始，Java也支持Lambda表达式。</p>
<p>最简单的Lambda表达式可由逗号分隔的参数列表、-&gt;符号和语句块组成，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;d&quot;).forEach(e -&gt; System.out.println(e));</span><br></pre></td></tr></table></figure>

<p>上面的参数e类型由编译器推导得出，也可显式指定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;d&quot;).forEach((String e) -&gt; System.out.println(e));</span><br></pre></td></tr></table></figure>

<p>对于复杂语句块，可以使用花括号扩起来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;d&quot;).forEach(e -&gt; &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">            System.out.println(e.contains(&quot;a&quot;));</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<p>Lambda可以引用类成员和局部变量，会将这些变量隐式得转换成final，如以下代码则会报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String t &#x3D; &quot;a&quot;;</span><br><span class="line">Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;d&quot;).forEach(e -&gt;</span><br><span class="line">  System.out.println(e + t)); &#x2F;&#x2F; Variable used in lambda expression should be final or effectively final</span><br><span class="line">t &#x3D; &quot;b&quot;;</span><br></pre></td></tr></table></figure>

<p>去掉 t=”b”; 则可正常运行。</p>
<p>Lambda表达式有返回值，返回值的类型也由编译器推理得出。如果Lambda表达式中的语句块只有一行，则可以不用使用return语句，下列两个代码片段效果相同：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;d&quot;).sort((e1, e2) -&gt; e1.compareTo(e2));</span><br><span class="line"></span><br><span class="line">Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;d&quot;).sort((e1, e2) -&gt; &#123;</span><br><span class="line">    return e1.compareTo(e2);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h4 id="函数式接口"><a href="#函数式接口" class="headerlink" title="函数式接口"></a>函数式接口</h4><p>在Java中，Lambda表达式则是一种折中的实现方式。Java的Lambda表达式依赖与函数接口，函数接口指的是只有一个抽象方法的接口，<br>这样的接口可以隐式转换为Lambda表达式。</p>
<p>还是从最简单的Lambda表达式开始：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;d&quot;).forEach(e -&gt; System.out.println(e));</span><br></pre></td></tr></table></figure>

<p>跳转至 Iterable 接口看看是怎么实现的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public interface Iterable&lt;T&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">  default void forEach(Consumer&lt;? super T&gt; action) &#123;</span><br><span class="line">        Objects.requireNonNull(action);</span><br><span class="line">        for (T t : this) &#123;</span><br><span class="line">            action.accept(t);</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里forEach方法接收了一个Consumer的参数，Consumer 则是一个函数接口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@FunctionalInterface</span><br><span class="line">public interface Consumer&lt;T&gt; &#123;</span><br><span class="line">    void accept(T t);</span><br><span class="line"></span><br><span class="line">    default Consumer&lt;T&gt; andThen(Consumer&lt;? super T&gt; after) &#123;</span><br><span class="line">        Objects.requireNonNull(after);</span><br><span class="line">        return (T t) -&gt; &#123; accept(t); after.accept(t); &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@FunctionalInterface 注解显式的声明了 Consumer 是个函数式接口，它仅有一个抽象方法accept()；<br>需要注意的是，默认方法和静态方法不会破坏函数式接口的定义，因此上面的代码是合法的；<br>这使得其可以被转换为Lamda表达式，正如上面的示例。</p>
<p>JDK 1.8新增的函数接口在java.util.function包下：</p>
<ul>
<li>Consumer&lt; T&gt; 代表了接受一个输入参数并且无返回的操作。 函数： void accept(T t);</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public interface Iterable&lt;T&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">  default void forEach(Consumer&lt;? super T&gt; action) &#123;</span><br><span class="line">        Objects.requireNonNull(action);</span><br><span class="line">        for (T t : this) &#123;</span><br><span class="line">            action.accept(t);</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;d&quot;).forEach(e -&gt; System.out.println(e));</span><br></pre></td></tr></table></figure>

<ul>
<li>Function&lt; T, R&gt; 接受一个输入参数，返回一个结果。 函数： R apply(T t);</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class HashMap&lt;K,V&gt; extends AbstractMap&lt;K,V&gt;</span><br><span class="line">    implements Map&lt;K,V&gt;, Cloneable, Serializable &#123;</span><br><span class="line">      ...</span><br><span class="line">      &#x2F;**</span><br><span class="line">         *</span><br><span class="line">         * 如果给定的key不存在（或者key对应的value为null），就去计算mappingFunction的值；(存在则返回已存入的值)</span><br><span class="line">         *</span><br><span class="line">         * 如果mappingFunction的值不为null，就把key&#x3D;value放进去；</span><br><span class="line">         * 如果mappingFunction的值为null，就不会记录该映射关系，返回值为null；</span><br><span class="line">         * 如果计算mappingFunction的值的过程出现异常，再次抛出异常，不记录映射关系，返回null；</span><br><span class="line">         *&#x2F;</span><br><span class="line">      @Override</span><br><span class="line">      public V computeIfAbsent(K key,</span><br><span class="line">                             Function&lt;? super K, ? extends V&gt; mappingFunction) &#123;</span><br><span class="line">        if (mappingFunction &#x3D;&#x3D; null)</span><br><span class="line">            throw new NullPointerException();</span><br><span class="line">        ...</span><br><span class="line">        V v &#x3D; mappingFunction.apply(key);</span><br><span class="line">        ...</span><br><span class="line">        return v;</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">HashMap&lt;String, String&gt; hashMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">hashMap.computeIfAbsent(&quot;key&quot;, k -&gt; k.toUpperCase()); &#x2F;&#x2F; putIfAbsent(&quot;key&quot;, &quot;KEY&quot;)</span><br></pre></td></tr></table></figure>

<ul>
<li>Predicate&lt; T&gt; 接受一个输入参数，返回一个布尔值结果。 函数： boolean test(T t);</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">static class Person &#123;</span><br><span class="line">  public enum Sex &#123;</span><br><span class="line">              MALE, FEMALE</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">  String name;</span><br><span class="line">  LocalDate birthday;</span><br><span class="line">  Sex gender;</span><br><span class="line">  String emailAddress;</span><br><span class="line">  int age;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void printPersonsWithPredicate(List&lt;Person&gt; roster, Predicate&lt;Person&gt; tester) &#123;</span><br><span class="line">    for (Person p : roster) &#123;</span><br><span class="line">        if (tester.test(p)) &#123;</span><br><span class="line">            p.printPerson();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">printPersonsWithPredicate(roster,</span><br><span class="line">                p -&gt; p.getGender() &#x3D;&#x3D; Person.Sex.MALE</span><br><span class="line">                        &amp;&amp; p.getAge() &gt;&#x3D; 18</span><br><span class="line">                        &amp;&amp; p.getAge() &lt;&#x3D; 25);</span><br></pre></td></tr></table></figure>

<ul>
<li>Supplier&lt; T&gt; 无参数，返回一个结果。 函数： T get();</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public final class Optional&lt; T&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">  public T orElseGet(Supplier&lt;? extends T&gt; other) &#123;</span><br><span class="line">      return value !&#x3D; null ? value : other.get();</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">System.out.println(Optional.ofNullable(null).orElseGet(() -&gt; &quot;B&quot;));</span><br></pre></td></tr></table></figure>

<ul>
<li>UnaryOperator&lt; T&gt; extends Function&lt; T, T&gt; 接受一个参数为类型T,返回值类型也为T。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public class AtomicReference&lt;V&gt; implements java.io.Serializable &#123;</span><br><span class="line">  ...</span><br><span class="line">  public final V updateAndGet(UnaryOperator&lt;V&gt; updateFunction) &#123;</span><br><span class="line">        V prev, next;</span><br><span class="line">        do &#123;</span><br><span class="line">            prev &#x3D; get();</span><br><span class="line">            next &#x3D; updateFunction.apply(prev);</span><br><span class="line">        &#125; while (!compareAndSet(prev, next));</span><br><span class="line">        return next;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static Person fake(String name)&#123;</span><br><span class="line">        Person person &#x3D; new Person();</span><br><span class="line">        person.name &#x3D; name;</span><br><span class="line">        ...</span><br><span class="line">        return person;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AtomicReference&lt;Person&gt; person &#x3D; new AtomicReference&lt;&gt;(roster.get(0));</span><br><span class="line">person.updateAndGet(p -&gt; fake(p.name));</span><br></pre></td></tr></table></figure>

<ul>
<li>BiConsumer&lt; T, U&gt; 代表了一个接受两个输入参数的操作，并且不返回任何结果。 函数： void accept(T t, U u);</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class ConcurrentHashMap&lt;K,V&gt; extends AbstractMap&lt;K,V&gt;</span><br><span class="line">    implements ConcurrentMap&lt;K,V&gt;, Serializable &#123;</span><br><span class="line">      ...</span><br><span class="line">      public void forEach(BiConsumer&lt;? super K, ? super V&gt; action) &#123;</span><br><span class="line">        if (action &#x3D;&#x3D; null) throw new NullPointerException();</span><br><span class="line">        Node&lt;K,V&gt;[] t;</span><br><span class="line">        if ((t &#x3D; table) !&#x3D; null) &#123;</span><br><span class="line">            Traverser&lt;K,V&gt; it &#x3D; new Traverser&lt;K,V&gt;(t, t.length, 0, t.length);</span><br><span class="line">            for (Node&lt;K,V&gt; p; (p &#x3D; it.advance()) !&#x3D; null; ) &#123;</span><br><span class="line">                action.accept(p.key, p.val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">concurrentHashMap.forEach((k, v) -&gt; System.out.println(k + &quot; &quot; + v));</span><br></pre></td></tr></table></figure>

<ul>
<li>BiFunction&lt; T, U, R&gt; 代表了一个接受两个输入参数的方法，并且返回一个结果。 函数： R apply(T t, U u);</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public class HashMap&lt;K,V&gt; extends AbstractMap&lt;K,V&gt;</span><br><span class="line">    implements Map&lt;K,V&gt;, Cloneable, Serializable &#123;</span><br><span class="line">      ...</span><br><span class="line">         public V computeIfPresent(K key,</span><br><span class="line">                                     BiFunction&lt;? super K, ? super V, ? extends V&gt; remappingFunction) &#123;</span><br><span class="line">               if (remappingFunction &#x3D;&#x3D; null)</span><br><span class="line">                   throw new NullPointerException();</span><br><span class="line">               Node&lt;K,V&gt; e; V oldValue;</span><br><span class="line">               int hash &#x3D; hash(key);</span><br><span class="line">               if ((e &#x3D; getNode(hash, key)) !&#x3D; null &amp;&amp;</span><br><span class="line">                   (oldValue &#x3D; e.value) !&#x3D; null) &#123;</span><br><span class="line">                   V v &#x3D; remappingFunction.apply(key, oldValue);</span><br><span class="line">                   if (v !&#x3D; null) &#123;</span><br><span class="line">                       e.value &#x3D; v;</span><br><span class="line">                       afterNodeAccess(e);</span><br><span class="line">                       return v;</span><br><span class="line">                   &#125;</span><br><span class="line">                   else</span><br><span class="line">                       removeNode(hash, key, null, false, true);</span><br><span class="line">               &#125;</span><br><span class="line">               return null;</span><br><span class="line">           &#125;</span><br><span class="line">      ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HashMap&lt;String, String&gt; hashMap &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">hashMap.computeIfAbsent(&quot;key&quot;, k -&gt; k.toUpperCase()); &#x2F;&#x2F; putIfAbsent(&quot;key&quot;, &quot;KEY&quot;)</span><br><span class="line">hashMap.computeIfPresent(&quot;key&quot;, (k, v) -&gt; k + v); &#x2F;&#x2F; put(&quot;key&quot;, &quot;keyKey&quot;)</span><br></pre></td></tr></table></figure>

<ul>
<li>BinaryOperator&lt; T&gt; extends BiFunction&lt; T,T,T&gt;  代表了一个作用于于两个同类型操作符的操作，并且返回了操作符同类型的结果。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class AtomicReference&lt;V&gt; implements java.io.Serializable &#123;</span><br><span class="line">  ...</span><br><span class="line">  public final V accumulateAndGet(V x,</span><br><span class="line">                                    BinaryOperator&lt;V&gt; accumulatorFunction) &#123;</span><br><span class="line">        V prev, next;</span><br><span class="line">        do &#123;</span><br><span class="line">            prev &#x3D; get();</span><br><span class="line">            next &#x3D; accumulatorFunction.apply(prev, x);</span><br><span class="line">        &#125; while (!compareAndSet(prev, next));</span><br><span class="line">        return next;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AtomicReference&lt;Integer&gt; integerAtomicReference &#x3D; new AtomicReference&lt;&gt;(Integer.valueOf(1));</span><br><span class="line">integerAtomicReference.accumulateAndGet(5, (oldValue, newValue) -&gt; oldValue + newValue);</span><br></pre></td></tr></table></figure>

<ul>
<li>BiPredicate&lt; T, U&gt; 代表了一个两个参数的boolean值方法。 函数： boolean test(T t, U u);</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BiPredicate&lt;Integer, Integer&gt; largeThan &#x3D; (x, y) -&gt; x &gt; y;</span><br><span class="line">System.out.println(largeThan.test(2, 3));</span><br></pre></td></tr></table></figure>

<p>基础接口为以上，其他接口都是带类型的，如IntConsumer，其接收参数为int；ObjDoubleConsumer，接收一个obj和一个double。</p>
<p>除开 java.util.function 包下的接口，其它常见函数接口如下：</p>
<ul>
<li><p>java.lang.Runnable</p>
</li>
<li><p>java.util.concurrent.Callable</p>
</li>
<li><p>java.util.Comparator</p>
</li>
</ul>
<h4 id="方法引用"><a href="#方法引用" class="headerlink" title="方法引用"></a>方法引用</h4><p>方法引用通过方法的名字来指向一个方法。使用符号 :: 。 这可以使得代码更为紧凑。</p>
<p>如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;d&quot;).forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<p>再如：<br>有一个 Car 类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">static class Car &#123;</span><br><span class="line">    public static Car create(Supplier&lt;Car&gt; supplier) &#123;</span><br><span class="line">        return supplier.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void collide(Car car) &#123;</span><br><span class="line">        System.out.println(&quot;Collided &quot; + car.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void follow(Car another) &#123;</span><br><span class="line">        System.out.println(&quot;Following the &quot; + another.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void repair() &#123;</span><br><span class="line">        System.out.println(&quot;Repaired &quot; + this.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>构造器引用：它的语法是Class::new，或者更一般的Class&lt; T &gt;::new</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Car car &#x3D; Car.create(Car::new);</span><br></pre></td></tr></table></figure>

<ul>
<li>静态方法引用 Class::static_method</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Car&gt; cars &#x3D; Arrays.asList(car);</span><br><span class="line">cars.forEach(Car::collide);</span><br></pre></td></tr></table></figure>

<ul>
<li>特定类的任意方法引用 Class::method</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cars.forEach(Car::repair);</span><br></pre></td></tr></table></figure>

<ul>
<li>特定对象的方法引用 instance::method</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Car lead &#x3D; Car.create(Car::new);</span><br><span class="line">cars.forEach(lead::follow);</span><br></pre></td></tr></table></figure>

<h4 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h4><p>Java 8 中的 Stream 是对集合（Collection）对象功能的增强，它专注于对集合对象进行各种非常便利、高效的聚合操作（aggregate operation），或者大批量数据操作 (bulk data operation)。Stream 不是集合元素，它不是数据结构并不保存数据，它是有关算法和计算的。它更像一个高级版本的 Iterator，不可以重复遍历里面的数据，像水一样，流过了就一去不复返。它和普通的 Iterator 不同的是，它可以并行遍历，普通的 Iterator 只能是串行，在一个线程中执行。</p>
<p>当使用串行方式去遍历时，每个 item 读完后再读下一个 item。而使用并行去遍历时，数据会被分成多个段，其中每一个都在不同的线程中处理，然后将结果一起输出。Stream 的并行操作依赖于 Java7 中引入的 Fork/Join 框架来拆分任务和加速处理过程。</p>
<p>Stream 的另外一大特点是，数据源本身可以是无限的。</p>
<h5 id="流的构成"><a href="#流的构成" class="headerlink" title="流的构成"></a>流的构成</h5><p>流的元素类型： Stream&lt; T&gt;, IntStream, LongStream, DoubleStream。</p>
<p>流计算由以下三部分构成： 流来源，0或多个中间操作，终止操作。</p>
<h6 id="流的来源-stream-source"><a href="#流的来源-stream-source" class="headerlink" title="流的来源(stream source)"></a>流的来源(stream source)</h6><ul>
<li>Colloection.stream() or parallelStream() 使用一个集合的元素创建一个流。  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List list &#x3D; Arrays.asList(&quot;a&quot;, &quot;b&quot;, &quot;d&quot;);</span><br><span class="line">Stream stream &#x3D; list.stream();</span><br></pre></td></tr></table></figure></li>
<li>Arrays.stream(T[] array) 使用数组创建流。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String[] array &#x3D; &#123;&quot;a&quot;, &quot;b&quot;, &quot;d&quot;&#125;;</span><br><span class="line">Stream stream &#x3D; Arrays.stream(array);</span><br></pre></td></tr></table></figure></li>
<li>Stream.of(T t) 使用单个元素创建一个流。  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stream stream &#x3D; Stream.of(Integer.valueOf(&quot;123&quot;));</span><br></pre></td></tr></table></figure></li>
<li>Stream.of(T… values) 使用多个元素创建一个流。  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stream stream &#x3D; Stream.of(Integer.valueOf(&quot;123&quot;), Double.valueOf(&quot;233.0&quot;));</span><br></pre></td></tr></table></figure></li>
<li>Stream.empty()    创建一个空流。</li>
<li>Stream.iterate(final T seed, final UnaryOperator&lt; T&gt; f) 创建一个包含序列 first, f(first), f(f(first)), … 的无限流<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stream stream &#x3D; Stream.iterate(1, e -&gt; e * 2); &#x2F;&#x2F; 2^N</span><br></pre></td></tr></table></figure></li>
<li>Stream.generate(Supplier<T> s) 使用一个生成器函数创建一个无限流。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stream stream &#x3D; Stream.generate(Math::random);</span><br></pre></td></tr></table></figure></li>
<li>IntStream.range(int startInclusive, int endExclusive) 创建一个由下限到上限之间的元素组成的 IntStream。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IntStream intStream &#x3D; IntStream.range(1,10); &#x2F;&#x2F; 1-9</span><br></pre></td></tr></table></figure></li>
<li>Random.ints() 创建由随机数构成的无限流。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IntStream intStream &#x3D; new Random().ints();</span><br></pre></td></tr></table></figure></li>
<li>其他： BufferedReader.lines(); BitSet.stream(); Stream.chars(); Files.list(Path dir);<br>Pattern.splitAsStream(CharSequence input); JarFile.stream(); etc..</li>
</ul>
<h6 id="中间操作-intermediate-operation"><a href="#中间操作-intermediate-operation" class="headerlink" title="中间操作(intermediate operation)"></a>中间操作(intermediate operation)</h6><p>中间操作负责将一个流转换为另一个流。一个流可以后面跟随零个或多个中间操作。其目的主要是打开流，做出某种程度的数据映射/过滤，然后返回一个新的流，交给下一个操作使用。这类操作都是 lazy 的，就是说，仅仅调用到这类方法，并没有真正开始流的遍历。</p>
<p>在对于一个 Stream 进行多次中间操作，每次都对 Stream 的每个元素进行转换，而且是执行多次，这样时间复杂度就是 N（转换次数）个 for 循环里把所有操作都做掉的总和吗？其实不是这样的，转换操作都是 lazy 的，多个中间操作只会在终止操作的时候融合起来，一次循环完成。我们可以这样简单的理解，Stream 里有个操作函数的集合，每次转换操作就是把转换函数放入这个集合中，在终结操作的时候循环 Stream 对应的集合，然后对每个元素执行所有的函数。</p>
<p>中间操作包括 filter()（选择与条件匹配的元素）、map()（根据函数来转换元素）、distinct()（删除重复）、limit()（在特定大小处截断流）和 sorted()。</p>
<p>中间操作可进一步划分为无状态和有状态操作。<br>无状态操作（比如 filter() 或 map()）可独立处理每个元素，而有状态操作（比如 sorted() 或 distinct()）可合并以前看到的影响其他元素处理的元素状态。</p>
<ul>
<li><p>filter(Predicate&lt; T&gt;)    与预期匹配的流的元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Person.createRoster().stream().filter(person -&gt; person.getGender() &#x3D;&#x3D; Person.Sex.MALE</span><br><span class="line">                &amp;&amp; person.getAge() &gt;&#x3D; 18).collect(Collectors.toList()); &#x2F;&#x2F; 查找18岁以上的男性</span><br></pre></td></tr></table></figure>
</li>
<li><p>map(Function&lt; T, U&gt;)    将提供的函数应用于流的元素的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person.createRoster().stream().map(person -&gt; person.getAge()).collect(Collectors.toSet()); &#x2F;&#x2F; 获取所有人的年龄集合</span><br></pre></td></tr></table></figure>
</li>
<li><p>flatMap(Function&lt; T, Stream&lt; U&gt;&gt;    将提供的流处理函数应用于流元素后获得的流元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String[] words &#x3D; new String[]&#123;&quot;abc&quot;,&quot;abc&quot;,&quot;abc&quot;&#125;;</span><br><span class="line">Arrays.stream(words)</span><br><span class="line">                .map(word -&gt; word.split(&quot;&quot;))</span><br><span class="line">                .flatMap(Arrays::stream) &#x2F;&#x2F; 将三个String[]流元素使用Arrays.stream(T..)处理获得String流</span><br><span class="line">                .distinct()</span><br><span class="line">                .forEach(System.out::print);</span><br></pre></td></tr></table></figure>
</li>
<li><p>distinct() 去除重复元素，实际使用了ConcurrentHashMap&lt; T, Boolean&gt;进行操作，所以是根据hashcode进行去重的。(参见DistinctOps类)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String[] words &#x3D; new String[]&#123;&quot;abc&quot;,&quot;abc&quot;,&quot;abc&quot;&#125;;</span><br><span class="line">Arrays.stream(words)</span><br><span class="line">                .map(word -&gt; word.split(&quot;&quot;))</span><br><span class="line">                .flatMap(Arrays::stream) &#x2F;&#x2F; 将三个String[]流元素使用Arrays.stream(T..)处理获得String流</span><br><span class="line">                .distinct() &#x2F;&#x2F;去重</span><br><span class="line">                .forEach(System.out::print); &#x2F;&#x2F;输出abc</span><br></pre></td></tr></table></figure>
</li>
<li><p>sorted() OR sorted(Comparator&lt;? super T&gt;) 对流元素进行排序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">String[] words &#x3D; new String[]&#123;&quot;cbad&quot;,&quot;def&quot;&#125;;</span><br><span class="line">        Arrays.stream(words)</span><br><span class="line">                .map(word -&gt; word.split(&quot;&quot;))</span><br><span class="line">                .flatMap(Arrays::stream)</span><br><span class="line">                .distinct()</span><br><span class="line">                .sorted()</span><br><span class="line">                .forEach(System.out::print); &#x2F;&#x2F; abcdef</span><br></pre></td></tr></table></figure>
</li>
<li><p>limit(long)    截断至所提供长度的流元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new Random().ints().limit(10).forEach(System.out::println); &#x2F;&#x2F;输出10个随机数</span><br></pre></td></tr></table></figure>
</li>
<li><p>skip(long)    丢弃了前 N 个元素的流元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stream.iterate(1, e -&gt; e * 2).limit(10).skip(5).forEach(System.out::println); &#x2F;&#x2F; 2^0 - 2^9 然后丢弃前5，即2^5 - 2^9</span><br></pre></td></tr></table></figure>
</li>
<li><p>peek() 主要为debug使用，给出流操作结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Stream.of(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;four&quot;)</span><br><span class="line">                .filter(e -&gt; e.length() &gt; 3)</span><br><span class="line">                .peek(e -&gt; System.out.println(&quot;Filtered value: &quot; + e))</span><br><span class="line">                .map(String::toUpperCase)</span><br><span class="line">                .peek(e -&gt; System.out.println(&quot;Mapped value: &quot; + e))</span><br><span class="line">                .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h6 id="终结操作-terminal-operation"><a href="#终结操作-terminal-operation" class="headerlink" title="终结操作(terminal operation)"></a>终结操作(terminal operation)</h6><p>一个流只能有一个终结操作，当这个操作执行后，流就被使用“光”了，无法再被操作。所以这必定是流的最后一个操作。终结操作的执行，才会真正开始流的遍历，并且会生成一个结果，或者一个side effect。</p>
<ul>
<li><p>forEach(Consumer&lt;? extends T&gt; action) / forEachOrdered(Consumer&lt;? super T&gt; action)    将提供的操作应用于流的每个元素。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new Random().ints().limit(10).forEach(System.out::println); &#x2F;&#x2F;输出10个随机数</span><br></pre></td></tr></table></figure>
</li>
<li><p>toArray()    使用流的元素创建一个数组。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new Random().ints().limit(10).toArray();</span><br></pre></td></tr></table></figure>
</li>
<li><p>reduce(…) 将流的元素聚合为一个汇总值。</p>
<ul>
<li>Optional&lt; T&gt; reduce(BinaryOperator&lt; T&gt; accumulator);  未定义初始值，从而第一次执行的时候第一个参数的值是Stream的第一个元素，第二个参数是Stream的第二个元素。</li>
<li>T reduce( T identity, BinaryOperator&lt; T&gt; accumulator); 定义了初始值，从而第一次执行的时候第一个参数的值是初始值，第二个参数是Stream的第一个元素。</li>
<li>&lt; U&gt; U reduce(U identity,BiFunction&lt; U, ? super T, U&gt; accumulator,BinaryOperator&lt; U&gt; combiner); combiner的作用在于合并每个线程的result得到最终结果。</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(&quot;10个随机数之和：&quot;</span><br><span class="line">                + new Random().ints()</span><br><span class="line">                .limit(10)</span><br><span class="line">                .reduce((acc, item) -&gt; acc + item)</span><br><span class="line">                .getAsInt());</span><br></pre></td></tr></table></figure>

<ul>
<li><p>collect(…)    将流的元素聚合到一个汇总结果容器中。</p>
<ul>
<li><p>&lt; R&gt; R collect(Supplier&lt; R&gt; supplier,BiConsumer&lt; R, ? super T&gt; accumulator,BiConsumer&lt; R, R&gt; combiner);</p>
</li>
<li><p>&lt; R, A&gt; R collect(Collector&lt;? super T, A, R&gt; collector);</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; stringList &#x3D; Stream.of(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;four&quot;)</span><br><span class="line">                .filter(e -&gt; e.length() &gt; 3)</span><br><span class="line">                .map(String::toUpperCase)</span><br><span class="line">                .collect(ArrayList::new, List::add, (left, right) -&gt; left.addAll(right)); &#x2F;&#x2F;同collect(Collectors.toList())</span><br></pre></td></tr></table></figure>

<ul>
<li><p>min(Comparator&lt;? super T&gt;)    通过比较符返回流的最小元素。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String[] words &#x3D; new String[]&#123;&quot;cbad&quot;,&quot;def&quot;&#125;;</span><br><span class="line">System.out.println(Arrays.stream(words)</span><br><span class="line">        .map(word -&gt; word.split(&quot;&quot;))</span><br><span class="line">        .flatMap(Arrays::stream)</span><br><span class="line">        .distinct()</span><br><span class="line">        .min((e1, e2) -&gt; e2.compareTo(e1)).get()); &#x2F;&#x2F; 这里逆序，返回f</span><br></pre></td></tr></table></figure>
</li>
<li><p>max(Comparator&lt;? super T&gt;)    通过比较符返回流的最大元素。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String[] words &#x3D; new String[]&#123;&quot;cbad&quot;,&quot;def&quot;&#125;;</span><br><span class="line">System.out.println(Arrays.stream(words)</span><br><span class="line">        .map(word -&gt; word.split(&quot;&quot;))</span><br><span class="line">        .flatMap(Arrays::stream)</span><br><span class="line">        .distinct()</span><br><span class="line">        .max((e1, e2) -&gt; e2.compareTo(e1)).get()); &#x2F;&#x2F; 这里逆序，返回a</span><br></pre></td></tr></table></figure>
</li>
<li><p>count() 返回流的大小。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String[] words &#x3D; new String[]&#123;&quot;cbad&quot;,&quot;def&quot;&#125;;</span><br><span class="line">System.out.println(Arrays.stream(words)</span><br><span class="line">        .map(word -&gt; word.split(&quot;&quot;))</span><br><span class="line">        .flatMap(Arrays::stream)</span><br><span class="line">        .distinct()</span><br><span class="line">        .count()); &#x2F;&#x2F; 输出6</span><br></pre></td></tr></table></figure>
</li>
<li><p>anyMatch(Predicate&lt;? super T&gt;) / allMatch(Predicate&lt;? super T&gt;) / noneMatch(Predicate&lt;? super T&gt;) 返回流的任何/所有元素是否与提供的预期相匹配。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String[] words &#x3D; new String[]&#123;&quot;cbad&quot;,&quot;def&quot;&#125;;</span><br><span class="line">System.out.println(Arrays.stream(words).allMatch(string -&gt; string.contains(&quot;d&quot;))); &#x2F;&#x2F; true</span><br></pre></td></tr></table></figure>
</li>
<li><p>findFirst() 返回流的第一个元素（如果有）。保证是第一个元素。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void createStream_whenFindFirstResultIsPresent_thenCorrect() &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; list &#x3D; Arrays.asList(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;);</span><br><span class="line"></span><br><span class="line">    Optional&lt;String&gt; result &#x3D; list.stream().findFirst();</span><br><span class="line"></span><br><span class="line">    assertTrue(result.isPresent());</span><br><span class="line">    assertThat(result.get(), is(&quot;A&quot;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>findAny() 返回流的任何元素（如果有）。不保证是第一个元素。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void createStream_whenFindAnyResultIsPresent_thenCorrect() &#123;</span><br><span class="line">    List&lt;String&gt; list &#x3D; Arrays.asList(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;);</span><br><span class="line"> </span><br><span class="line">    Optional&lt;String&gt; result &#x3D; list.stream().findAny();</span><br><span class="line"> </span><br><span class="line">    assertTrue(result.isPresent());</span><br><span class="line">    assertThat(result.get(), anyOf(is(&quot;A&quot;), is(&quot;B&quot;), is(&quot;C&quot;), is(&quot;D&quot;)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h6 id="Collectors"><a href="#Collectors" class="headerlink" title="Collectors"></a>Collectors</h6><p>终结操作中 collect 方法有两种入参，一是接收三个方法参数，二是接收一个Collector方法。而Collectors类中则内置了常用Collector。</p>
<ul>
<li>toCollection(Supplier&lt; C&gt; collectionFactory) 自定义集合类收集元素</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; linkedListResult &#x3D; Arrays.asList(&quot;cbad&quot;,&quot;def&quot;).stream().collect(Collectors.toCollection(LinkedList::new));</span><br></pre></td></tr></table></figure>

<ul>
<li>toList() 转ArrayList</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; arrayListResult &#x3D; Arrays.asList(&quot;cbad&quot;,&quot;def&quot;).stream().collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<ul>
<li>toSet() 转hashSet</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Person.createRoster()</span><br><span class="line">    .stream()</span><br><span class="line">    .map(person -&gt; person.getAge())</span><br><span class="line">    .collect(Collectors.toSet());</span><br></pre></td></tr></table></figure>

<ul>
<li>joining() / joining(CharSequence delimiter) / joining(CharSequence delimiter,CharSequence prefix,CharSequence suffix) 拼接</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String[] words &#x3D; new String[]&#123;&quot;cbad&quot;,&quot;def&quot;&#125;;</span><br><span class="line">System.out.println(Arrays.stream(words).collect(Collectors.joining())); &#x2F;&#x2F; cbaddef</span><br><span class="line">System.out.println(Arrays.stream(words).collect(Collectors.joining(&quot;-&quot;))); &#x2F;&#x2F; cbad-def</span><br><span class="line">System.out.println(Arrays.stream(words).collect(Collectors.joining(&quot;-&quot;, &quot;START[&quot;, &quot;]END&quot;))); &#x2F;&#x2F; START[cbad-def]END</span><br></pre></td></tr></table></figure>

<ul>
<li>mapping(Function&lt;? super T, ? extends U&gt; mapper, Collector&lt;? super U, A, R&gt; downstream) 在聚合前先对元素进行操作</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stream.of(&quot;cbad&quot;,&quot;def&quot;).collect(Collectors.mapping(x -&gt; x.toUpperCase(), Collectors.joining(&quot;,&quot;))); &#x2F;&#x2F;CBAD,DEF</span><br></pre></td></tr></table></figure>

<ul>
<li>collectingAndThen(Collector&lt; T,A,R&gt; downstream, Function&lt; R,RR&gt; finisher) 对聚合后的数据进行处理</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Person.Sex, Person&gt; oldestPeople &#x3D;  Person.createRoster().stream()</span><br><span class="line">                .collect(</span><br><span class="line">                        Collectors.groupingBy(</span><br><span class="line">                                Person::getGender,    &#x2F;&#x2F; 根据性别分类</span><br><span class="line">                                Collectors.collectingAndThen(</span><br><span class="line">                                        Collectors.maxBy(Comparator.comparingInt(Person::getAge)), &#x2F;&#x2F; 分别获取最大年龄</span><br><span class="line">                                        Optional::get) &#x2F;&#x2F; 对聚合结果（最大年龄）进行get</span><br><span class="line">                                        ));</span><br></pre></td></tr></table></figure>

<ul>
<li><p>counting() 统计输入元素数量</p>
</li>
<li><p>minBy(Comparator&lt;? super T&gt; comparator) maxBy(Comparator&lt;? super T&gt; comparator) 获取最小/大元素</p>
</li>
<li><p>summingInt(ToIntFunction&lt;? super T&gt; mapper) / summingLong / summingDouble 求和</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person.createRoster().stream().collect(Collectors.summingInt(Person::getAge));</span><br></pre></td></tr></table></figure>

<ul>
<li>averagingInt(ToIntFunction&lt;? super T&gt; mapper) / averagingLong / averagingDouble 求平均</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person.createRoster().stream().collect(Collectors.averagingInt(Person::getAge));</span><br></pre></td></tr></table></figure>

<ul>
<li>reducing(…)  将流的元素聚合为一个汇总值。<ul>
<li>Collector&lt; T, ?, Optional&lt; T&gt;&gt; reducing(BinaryOperator&lt; T&gt; op)</li>
<li>Collector&lt; T, ?, T&gt; reducing(T identity, BinaryOperator&lt; T&gt; op)</li>
<li>Collector&lt; T, ?, U&gt; reducing(U identity,Function&lt;? super T, ? extends U&gt; mapper,BinaryOperator&lt; U&gt; op)</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(</span><br><span class="line">                Stream.of(1, 2, 3, 4).collect(</span><br><span class="line">                        Collectors.reducing(0, (acc, item) -&gt; acc + item)));</span><br></pre></td></tr></table></figure>

<ul>
<li><p>groupingBy(…) / groupingByConcurrent(…)  分组聚合</p>
<ul>
<li><p>Collector&lt; T, ?, Map&lt;K, List&lt; T&gt;&gt;&gt; groupingBy(Function&lt;? super T, ? extends K&gt; classifier)</p>
</li>
<li><p>Collector&lt; T, ?, Map&lt; K, D&gt;&gt; groupingBy(Function&lt;? super T, ? extends K&gt; classifier,Collector&lt;? super T, A, D&gt; downstream)</p>
</li>
<li><p>&lt; T, K, D, A, M extends Map&lt; K, D&gt;&gt; Collector&lt; T, ?, M&gt; groupingBy(Function&lt;? super T, ? extends K&gt; classifier,Supplier&lt; M&gt; mapFactory,Collector&lt;? super T, A, D&gt; downstream)</p>
</li>
<li><p>Collector&lt; T, ?, ConcurrentMap&lt; K, List&lt; T&gt;&gt;&gt; groupingByConcurrent(Function&lt;? super T, ? extends K&gt; classifier)</p>
</li>
<li><p>Collector&lt; T, ?, ConcurrentMap&lt; K, D&gt;&gt; groupingByConcurrent(Function&lt;? super T, ? extends K&gt; classifier,Collector&lt;? super T, A, D&gt; downstream)</p>
</li>
<li><p>&lt; T, K, A, D, M extends ConcurrentMap&lt; K, D&gt;&gt;<br>Collector&lt; T, ?, M&gt; groupingByConcurrent(Function&lt;? super T, ? extends K&gt; classifier,Supplier&lt; M&gt; mapFactory,Collector&lt;? super T, A, D&gt; downstream) </p>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Person.Sex, List&lt;Person&gt;&gt; peopleGroupBySex &#x3D;  Person.createRoster().stream()</span><br><span class="line">    .collect(Collectors.groupingBy(Person::getGender));</span><br></pre></td></tr></table></figure>

<ul>
<li>partitioningBy(…) 分类为是否符合给定条件的两类<ul>
<li>Collector&lt; T, ?, Map&lt; Boolean, List&lt; T&gt;&gt;&gt; partitioningBy(Predicate&lt;? super T&gt; predicate)</li>
<li>Collector&lt; T, ?, Map&lt; Boolean, D&gt;&gt; partitioningBy(Predicate&lt;? super T&gt; predicate, Collector&lt;? super T, A, D&gt; downstream)</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Boolean, List&lt;Person&gt;&gt; peopleGroupBySex &#x3D;  Person.createRoster().stream()</span><br><span class="line">        .collect(</span><br><span class="line">                Collectors.partitioningBy(</span><br><span class="line">                        person -&gt; person.getAge() &gt;&#x3D; 18</span><br><span class="line">                                &amp;&amp; person.getGender() &#x3D;&#x3D; Person.Sex.MALE)</span><br><span class="line">                );</span><br></pre></td></tr></table></figure>

<ul>
<li><p>toMap(…) / toConcurrentMap(…)</p>
<ul>
<li><p>Collector&lt; T, ?, Map&lt;K,U&gt;&gt; toMap(Function&lt;? super T, ? extends K&gt; keyMapper,Function&lt;? super T, ? extends U&gt; valueMapper)</p>
</li>
<li><p>Collector&lt; T, ?, Map&lt;K,U&gt;&gt; toMap(Function&lt;? super T, ? extends K&gt; keyMapper,Function&lt;? super T, ? extends U&gt; valueMapper,BinaryOperator&lt; U&gt; mergeFunction)</p>
</li>
<li><p>Collector&lt; T, ?, M&gt; toMap(Function&lt;? super T, ? extends K&gt; keyMapper,Function&lt;? super T, ? extends U&gt; valueMapper,BinaryOperator&lt; U&gt; mergeFunction,Supplier&lt; M&gt; mapSupplier)</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Integer, Person&gt; people &#x3D;  Person.createRoster().stream()</span><br><span class="line">                .collect(</span><br><span class="line">                        Collectors.toMap(Person::getAge,</span><br><span class="line">                                Function.identity(), (oldValue, item) -&gt; item)  &#x2F;&#x2F; 这里使用了hashmap.merge，默认两参数会抛出异常，这里定义了冲突时的操作</span><br><span class="line">                        );</span><br></pre></td></tr></table></figure>

<ul>
<li>Collector&lt; T, ?, IntSummaryStatistics&gt; summarizingInt(ToIntFunction&lt;? super T&gt; mapper) / summarizingLong / summarizingDouble<br>获得统计信息 最大值，最小值，平均数，总数，总和<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Optional.ofNullable(</span><br><span class="line">                roster.stream().</span><br><span class="line">                        collect(Collectors.summarizingInt(Person::getAge)))</span><br><span class="line">                .ifPresent(System.out::println); &#x2F;&#x2F;IntSummaryStatistics&#123;count&#x3D;20, sum&#x3D;107, min&#x3D;0, average&#x3D;5.350000, max&#x3D;9&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<hr>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><p><a href="https://www.cnblogs.com/xingzc/p/6002873.html" target="_blank" rel="noopener">JAVA8 十大新特性详解</a></p>
</li>
<li><p><a href="https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html" target="_blank" rel="noopener">Lambda Expressions</a></p>
</li>
<li><p><a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/package-summary.html" target="_blank" rel="noopener">Stream Oracle文档</a></p>
</li>
<li><p><a href="https://www.baeldung.com/java-stream-findfirst-vs-findany" target="_blank" rel="noopener">java-stream-findfirst-vs-findany</a></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyyljs.site/2019/05/04/jdk8%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" data-id="ckaqogbtj000943o68dx1avl4" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-OWASP第三方依赖检查插件使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/27/OWASP%E7%AC%AC%E4%B8%89%E6%96%B9%E4%BE%9D%E8%B5%96%E6%A3%80%E6%9F%A5%E6%8F%92%E4%BB%B6%E4%BD%BF%E7%94%A8/" class="article-date">
  <time datetime="2019-04-27T14:22:32.000Z" itemprop="datePublished">2019-04-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/27/OWASP%E7%AC%AC%E4%B8%89%E6%96%B9%E4%BE%9D%E8%B5%96%E6%A3%80%E6%9F%A5%E6%8F%92%E4%BB%B6%E4%BD%BF%E7%94%A8/">OWASP第三方依赖检查插件使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="什么是OWASP"><a href="#什么是OWASP" class="headerlink" title="什么是OWASP"></a>什么是OWASP</h5><p>OWASP(开放Web软体安全项目- Open Web Application Security Project) 是一个开源的、非盈利的全球性安全组织，致力于应用软件的安全研究。<br>其使命是使应用软件更加安全，使企业和组织能够对应用安全风险作出更清晰的决策。<br>目前OWASP全球拥有130个分会近万名会员，共同推动了安全标准、安全测试工具、安全指导手册等应用安全技术的发展。</p>
<h5 id="OWASP-Dependency-Check-简介"><a href="#OWASP-Dependency-Check-简介" class="headerlink" title="OWASP Dependency Check 简介"></a>OWASP Dependency Check 简介</h5><p>Dependency-Check 是其旗下出品的一个第三方依赖检查工具，可以检查项目依赖包存在的已知、公开披露的漏洞。<br>目前良好的支持Java和.NET；Ruby、Node.js、Python处于实验阶段；仅支持通过(autoconf and cmake)编译的C/C++。<br>针对<a href="https://www.owasp.org/index.php/Top_10-2017_A9-Using_Components_with_Known_Vulnerabilities" target="_blank" rel="noopener">OWASP Top 10 2017 A9-Using Components with Known Vulnerabilities</a>提供部分解决方案。</p>
<h5 id="OWASP-Dependency-Check的使用"><a href="#OWASP-Dependency-Check的使用" class="headerlink" title="OWASP Dependency Check的使用"></a>OWASP Dependency Check的使用</h5><ul>
<li>dependency-check-maven</li>
</ul>
<p>使用方式有多种，可直接在maven/gradle/ant集成使用，可单独作为命令行工具使用，也可集成在jenkins/sonarqube中使用。<br>这里采用集成在maven中作为示例。更多使用方法可在文末github链接中找到。</p>
<p>pom文件添加如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;project&gt;</span><br><span class="line">    ...</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        ...</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            ...</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">              &lt;groupId&gt;org.owasp&lt;&#x2F;groupId&gt;</span><br><span class="line">              &lt;artifactId&gt;dependency-check-maven&lt;&#x2F;artifactId&gt;</span><br><span class="line">              &lt;version&gt;5.0.0-M2&lt;&#x2F;version&gt;</span><br><span class="line">              &lt;executions&gt;</span><br><span class="line">                  &lt;execution&gt;</span><br><span class="line">                      &lt;goals&gt;</span><br><span class="line">                          &lt;goal&gt;check&lt;&#x2F;goal&gt;</span><br><span class="line">                      &lt;&#x2F;goals&gt;</span><br><span class="line">                  &lt;&#x2F;execution&gt;</span><br><span class="line">              &lt;&#x2F;executions&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">            ...</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">        ...</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br><span class="line">    ...</span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>

<p>默认情况下，check操作绑定在 mvn verify和site的生命周期中。</p>
<p>这里使用 mvn verify来进行检查。</p>
<p>在下载完依赖后，插件会去下载NVD CVE列表然后进行检查，因为网络原因，这一操作非常缓慢。</p>
<p><img src="/images/owasp/slow.png" alt="slow"></p>
<ul>
<li>NIST Data Mirror</li>
</ul>
<p>因为直接拉取NVD CVE文件非常慢，所以想法是先使用其他方法下载到本地，然后再让dependency check使用本地镜像。</p>
<p><a href="https://github.com/stevespringett/nist-data-mirror/" target="_blank" rel="noopener">NIST Data Mirror</a>工具可以来实现这个过程。</p>
<p>git clone 工具，然后 mvn clean package 打包，在target目录下执行 java -jar nist-data-mirror.jar <mirror-directory> 开始下载。</p>
<p><img src="/images/owasp/nist.png" alt="nist"></p>
<p>下载完毕后，修改配置路径为本地</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;project&gt;</span><br><span class="line">    ...</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        ...</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            ...</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.owasp&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;dependency-check-maven&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;version&gt;5.0.0-M2&lt;&#x2F;version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;cveUrl12Modified&gt;mirror-directory&#x2F;nvdcve-Modified.xml.gz&lt;&#x2F;cveUrl12Modified&gt;</span><br><span class="line">                    &lt;cveUrl20Modified&gt;mirror-directory&#x2F;nvdcve-2.0-Modified.xml.gz&lt;&#x2F;cveUrl20Modified&gt;</span><br><span class="line">                    &lt;cveUrl12Base&gt;mirror-directory&#x2F;nvdcve-%d.xml&lt;&#x2F;cveUrl12Base&gt;</span><br><span class="line">                    &lt;cveUrl20Base&gt;mirror-directory&#x2F;nvdcve-2.0-%d.xml&lt;&#x2F;cveUrl20Base&gt;</span><br><span class="line">                &lt;&#x2F;configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;check&lt;&#x2F;goal&gt;</span><br><span class="line">                        &lt;&#x2F;goals&gt;</span><br><span class="line">                    &lt;&#x2F;execution&gt;</span><br><span class="line">                &lt;&#x2F;executions&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">            ...</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">        ...</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br><span class="line">    ...</span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>

<p>在执行 mvn verify，一小会便结束。</p>
<p>需要注意的是，需要定期去更新这些文件以便保持最新。</p>
<ul>
<li>查看结果</li>
</ul>
<p>默认情况下会在 target 文件夹下生成 dependency-check-report.html。</p>
<p>打开该报告，其中会列出有问题的依赖组件，并在后文附上该组件包含哪些漏洞。</p>
<p><img src="/images/owasp/report.png" alt="report"></p>
<p><img src="/images/owasp/report-cve.png" alt="report-cve"></p>
<hr>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><p><a href="https://jeremylong.github.io/DependencyCheck/" target="_blank" rel="noopener">OWASP_Dependency_Check 文档</a></p>
</li>
<li><p><a href="https://github.com/jeremylong/DependencyCheck" target="_blank" rel="noopener">OWASP_Dependency_Check GitHub</a></p>
</li>
<li><p><a href="https://jeremylong.github.io/DependencyCheck/dependency-check-maven/" target="_blank" rel="noopener">dependency-check-maven</a></p>
</li>
<li><p><a href="https://github.com/stevespringett/nist-data-mirror/" target="_blank" rel="noopener">NIST Data Mirror</a></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyyljs.site/2019/04/27/OWASP%E7%AC%AC%E4%B8%89%E6%96%B9%E4%BE%9D%E8%B5%96%E6%A3%80%E6%9F%A5%E6%8F%92%E4%BB%B6%E4%BD%BF%E7%94%A8/" data-id="ckaqogbtg000843o6dfvh7fgt" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docker搭建jenkins" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/11/docker%E6%90%AD%E5%BB%BAjenkins/" class="article-date">
  <time datetime="2019-04-11T13:58:00.000Z" itemprop="datePublished">2019-04-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/11/docker%E6%90%AD%E5%BB%BAjenkins/">docker搭建jenkins</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="使用docker搭建jenkins"><a href="#使用docker搭建jenkins" class="headerlink" title="使用docker搭建jenkins"></a>使用docker搭建jenkins</h3><p>jenkins目前官方有三个镜像，jenkins,jenkins/jenkins,和jenkins/jenkins:lts。其中 jenkins/jenkins 是每周更新，jenkins/jenkins:lts 是长期支持版本，而目前的 jenkins 镜像则会被废弃以更好的支持 jenkins/jenkins:lts 。</p>
<ul>
<li><p>创建jenkins文件夹存储数据</p>
</li>
<li><p>创建docker-compose.yml</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3.1&#39;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  jinkins:</span><br><span class="line">    container_name: jenkins</span><br><span class="line">    hostname: jenkins</span><br><span class="line">    image: jenkins&#x2F;jenkins:lts</span><br><span class="line">    networks:</span><br><span class="line">      - default</span><br><span class="line">      - dbnetwork</span><br><span class="line">    ports:</span><br><span class="line">      - 10080:8080</span><br><span class="line">      - 50000:50000</span><br><span class="line">    volumes:</span><br><span class="line">      - ~&#x2F;dbs&#x2F;jenkins:&#x2F;var&#x2F;jenkins_home</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  dbnetwork:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure>

<ul>
<li>启动，访问localhost:10080，配置jenkins并使用。</li>
</ul>
<h3 id="使用jenkins构建项目"><a href="#使用jenkins构建项目" class="headerlink" title="使用jenkins构建项目"></a>使用jenkins构建项目</h3><h4 id="配置jenkins，gitlab"><a href="#配置jenkins，gitlab" class="headerlink" title="配置jenkins，gitlab"></a>配置jenkins，gitlab</h4><ul>
<li>jenkins配置jdk,maven,gradle</li>
</ul>
<p>Manage jenkins=&gt;Global Tool Configuration</p>
<p>JDK有多种方式，如果有挂载jdk可直接配置路径使用；</p>
<p>也可以采用从官网下载自动安装(需要Oracle账号)；</p>
<p>或者自定义下载地址..etc</p>
<p>Gradle 和 Maven 相同。</p>
<ul>
<li>jenkins生成sshkey</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it jenkins &#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">mkdir ~&#x2F;.ssh</span><br><span class="line"></span><br><span class="line">cd ~&#x2F;.ssh</span><br><span class="line"></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line"></span><br><span class="line">cat id_rsa.pub</span><br></pre></td></tr></table></figure>

<ul>
<li>将jenkins的公钥配置到gitlab账户中</li>
</ul>
<p><img src="/images/jenkins/gitlab-add-sshkeys.png" alt="gitlab-add-sshkey"></p>
<ul>
<li>新建job，填入名称并选择freestyle类型</li>
</ul>
<p><img src="/images/jenkins/jenkins-new-item.png" alt="jenkins-new-item"></p>
<ul>
<li>配置source为git，填入地址，并添加认证方式，因之前配置了gitlab的sshkeys，这里也使用ssh方式</li>
</ul>
<p><img src="/images/jenkins/jenkins-add-source.png" alt="jenkins-add-source"></p>
<p><img src="/images/jenkins/jenkins-add-sshkey.png" alt="jenkins-add-sshkey"></p>
<ul>
<li>配置触发Build行为，这里由webhook触发，点击advanced，配置哪些事件哪些分支触发，并点击Generate生成Secret token。</li>
</ul>
<p><img src="/images/jenkins/jenkins-gitlab-trigger.png" alt="jenkins-gitlab-trigger"></p>
<p><img src="/images/jenkins/jenkins-gitlab-token.png" alt="jenkins-gitlab-token"></p>
<ul>
<li>在gitlab项目的设置-集成中配置webhook，填入对应的url，将jenkins的Secret Token拷贝并填写进来，并关闭SSL验证</li>
</ul>
<p><img src="/images/jenkins/gitlab-jenkins-token.png" alt="gitlab-webhook"></p>
<ul>
<li>在jenkins配置build，我这里示例是maven项目，选择Invoke top-level Maven targets，配置maven版本，以及goals，在Advanced中还可配置pom文件，setting.xml文件等</li>
</ul>
<p><img src="/images/jenkins/jenkins-maven-select.png" alt="jenkins-maven-select"></p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>push代码，测试是否有进行maven package。在jenkins控制台能看见进程。</p>
<p><img src="/images/jenkins/jenkins-project.png" alt="jenkins-project"></p>
<p><img src="/images/jenkins/jenkins-console.png" alt="jenkins-console"></p>
<p>待package完成后，在workspace的target下即能找到对应的jar文件了。</p>
<p><img src="/images/jenkins/jenkins-workspace.png" alt="jenkins-workspace"></p>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><p><a href="https://hub.docker.com/r/jenkins/jenkins" target="_blank" rel="noopener">docker hub jenkins</a></p>
</li>
<li><p><a href="https://github.com/jenkinsci/docker/blob/master/README.md" target="_blank" rel="noopener">docker jenkins readme</a></p>
</li>
<li><p><a href="https://github.com/jenkinsci/jenkins" target="_blank" rel="noopener">jenkins github</a></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyyljs.site/2019/04/11/docker%E6%90%AD%E5%BB%BAjenkins/" data-id="ckaqogbtm000a43o66g0lhf0c" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-使用docker搭建gitlab" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/11/%E4%BD%BF%E7%94%A8docker%E6%90%AD%E5%BB%BAgitlab/" class="article-date">
  <time datetime="2019-04-11T09:40:00.000Z" itemprop="datePublished">2019-04-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/11/%E4%BD%BF%E7%94%A8docker%E6%90%AD%E5%BB%BAgitlab/">使用docker搭建gitlab,postgres,redis</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="直接使用gitlab-ce镜像"><a href="#直接使用gitlab-ce镜像" class="headerlink" title="直接使用gitlab-ce镜像"></a>直接使用gitlab-ce镜像</h4><p>从docker hub上找到社区版的gitlab镜像，然后从readme指南找到示例docker-compose.yml，稍作修改便可直接使用。</p>
<p>创建config,logs,data文件夹；</p>
<p>创建docker-compose.yml文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3&#39;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  gitlab:</span><br><span class="line">    container_name: gitlab</span><br><span class="line">    image: gitlab&#x2F;gitlab-ce</span><br><span class="line">    hostname: gitlab</span><br><span class="line">    #restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8443:443&quot;</span><br><span class="line">      - &quot;8989:8989&quot;</span><br><span class="line">      - &quot;2222:22&quot;</span><br><span class="line">    environment:</span><br><span class="line">      GITLAB_OMNIBUS_CONFIG: |</span><br><span class="line">        external_url &#39;http:&#x2F;&#x2F;127.0.0.1:8989&#39;</span><br><span class="line"></span><br><span class="line">    volumes:</span><br><span class="line">      - ~&#x2F;dbs&#x2F;gitlab&#x2F;config:&#x2F;etc&#x2F;gitlab</span><br><span class="line">      - ~&#x2F;dbs&#x2F;gitlab&#x2F;logs:&#x2F;var&#x2F;log&#x2F;gitlab</span><br><span class="line">      - ~&#x2F;dbs&#x2F;gitlab&#x2F;data:&#x2F;var&#x2F;opt&#x2F;gitlab</span><br></pre></td></tr></table></figure>

<p>在开始时映射端口未加引号导致出现端口映射错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for gitlab Cannot create container for service gitlab: invalid port specification: &quot;133342&quot;</span><br></pre></td></tr></table></figure>

<p>原因可参考<a href="https://forums.docker.com/t/docker-failing-to-correctly-process-valid-yaml-config/183/3" target="_blank" rel="noopener">docker错误解析yml配置</a>，在端口加上引号即可解决。</p>
<h4 id="使用外置redis和postgres"><a href="#使用外置redis和postgres" class="headerlink" title="使用外置redis和postgres"></a>使用外置redis和postgres</h4><p>gitlab镜像自带了redis和postgres，这里可以改用外置的redis和postgres。</p>
<h5 id="docker搭建postgres"><a href="#docker搭建postgres" class="headerlink" title="docker搭建postgres"></a>docker搭建postgres</h5><p>先使用docker搭建postgres。</p>
<ul>
<li><p>创建postgres文件夹用于存储数据。</p>
</li>
<li><p>使用docker network create dbnetwork创建docker网络用于容器间互通。</p>
</li>
<li><p>创建docker-compose.yml文件如下：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3.1&#39;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line"></span><br><span class="line">  postgres:</span><br><span class="line">    container_name: postgres</span><br><span class="line">    hostname: postgres</span><br><span class="line">    image: postgres</span><br><span class="line">    #restart: always</span><br><span class="line">    networks:</span><br><span class="line">      - default</span><br><span class="line">      - dbnetwork</span><br><span class="line">    ports:</span><br><span class="line">      - 5432:5432</span><br><span class="line">    environment:</span><br><span class="line">      POSTGRES_USER: lyyljs</span><br><span class="line">      POSTGRES_PASSWORD: 123456</span><br><span class="line">    volumes:</span><br><span class="line">      - ~&#x2F;dbs&#x2F;postgres:&#x2F;var&#x2F;lib&#x2F;postgresql&#x2F;data</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  dbnetwork:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure>

<ul>
<li><p>如果本机有装psql客户端，则使用命令 <strong>psql -h 127.0.0.1 -U lyyljs</strong> 命令连接数据库。然后创建数据库gitlabhq: CREATE DATABASE gitlabhq OWNER lyyljs;</p>
</li>
<li><p>如果没有装psql，则可使用docker 镜像<a href="https://hub.docker.com/_/adminer" target="_blank" rel="noopener">adminer</a>，并创建数据库。</p>
</li>
</ul>
<h5 id="gitlab使用外置postgres"><a href="#gitlab使用外置postgres" class="headerlink" title="gitlab使用外置postgres"></a>gitlab使用外置postgres</h5><p>修改gitlab的docker-compose.yml，使其使用该容器postgres。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3&#39;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  gitlab:</span><br><span class="line">    container_name: gitlab</span><br><span class="line">    image: gitlab&#x2F;gitlab-ce</span><br><span class="line">    hostname: gitlab</span><br><span class="line">    #restart: always</span><br><span class="line">    networks:</span><br><span class="line">      - default</span><br><span class="line">      - dbnetwork</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8443:443&quot;</span><br><span class="line">      - &quot;8989:8989&quot;</span><br><span class="line">      - &quot;10022:22&quot;</span><br><span class="line">    environment:</span><br><span class="line">      GITLAB_OMNIBUS_CONFIG: |</span><br><span class="line">        external_url &#39;http:&#x2F;&#x2F;127.0.0.1:8989&#39;</span><br><span class="line">        postgresql[&#39;enable&#39;] &#x3D; false</span><br><span class="line">        gitlab_rails[&#39;db_adapter&#39;] &#x3D; &#39;postgresql&#39;</span><br><span class="line">        gitlab_rails[&#39;db_encoding&#39;] &#x3D; &#39;utf8&#39;</span><br><span class="line">        gitlab_rails[&#39;db_host&#39;] &#x3D; &#39;postgres&#39;</span><br><span class="line">        gitlab_rails[&#39;db_port&#39;] &#x3D; &#39;5432&#39;</span><br><span class="line">        gitlab_rails[&#39;db_username&#39;] &#x3D; &#39;lyyljs&#39;</span><br><span class="line">        gitlab_rails[&#39;db_password&#39;] &#x3D; &#39;123456&#39;</span><br><span class="line">        gitlab_rails[&#39;db_database&#39;] &#x3D; &quot;gitlabhq&quot;</span><br><span class="line"></span><br><span class="line">    volumes:</span><br><span class="line">      - ~&#x2F;dbs&#x2F;gitlab&#x2F;config:&#x2F;etc&#x2F;gitlab</span><br><span class="line">      - ~&#x2F;dbs&#x2F;gitlab&#x2F;logs:&#x2F;var&#x2F;log&#x2F;gitlab</span><br><span class="line">      - ~&#x2F;dbs&#x2F;gitlab&#x2F;data:&#x2F;var&#x2F;opt&#x2F;gitlab</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  dbnetwork:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure>

<p>可通过 docker exec -it gitlab /bin/bash 进入gitlab容器控制台，再通过 psql -h postgres -U lyyljs 测试连通，访问外置数据库。</p>
<h5 id="docker搭建redis"><a href="#docker搭建redis" class="headerlink" title="docker搭建redis"></a>docker搭建redis</h5><ul>
<li><p>创建redis文件夹用于存储持久化数据。</p>
</li>
<li><p>然后使用docker-compose.yml快速搭建redis。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3.1&#39;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  redis:</span><br><span class="line">    container_name: redis</span><br><span class="line">    hostname: redis</span><br><span class="line">    image: redis</span><br><span class="line">    #restart: always</span><br><span class="line">    networks:</span><br><span class="line">      - default</span><br><span class="line">      - dbnetwork</span><br><span class="line">    ports:</span><br><span class="line">      - 6379:6379</span><br><span class="line">    volumes:</span><br><span class="line">      - ~&#x2F;dbs&#x2F;redis:&#x2F;data</span><br><span class="line">networks:</span><br><span class="line">  dbnetwork:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure>

<ul>
<li>启动后本地可使用 redis-cli 直接连接，并使用 get a 测试连通。</li>
</ul>
<p>但此时有问题是redis默认是没有密码的，现在想使用自定义配置。新建redis.conf文件，从官方包下copy内容，添加需要密码，并取消只监听localhost。</p>
<p>从<a href="https://hub.docker.com/_/redis" target="_blank" rel="noopener">官网文档</a>上根据docker命令修改image。</p>
<p>新建Dockerfile文件，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM redis</span><br><span class="line">COPY redis.conf &#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis&#x2F;redis.conf</span><br><span class="line">CMD [ &quot;redis-server&quot;, &quot;&#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis&#x2F;redis.conf&quot; ]</span><br></pre></td></tr></table></figure>

<p>然后修改docker-compose.yml文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3.1&#39;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  redis:</span><br><span class="line">    container_name: redis</span><br><span class="line">    hostname: redis</span><br><span class="line">    build: .</span><br><span class="line">    #restart: always</span><br><span class="line">    networks:</span><br><span class="line">      - default</span><br><span class="line">      - dbnetwork</span><br><span class="line">    ports:</span><br><span class="line">      - 6379:6379</span><br><span class="line">    volumes:</span><br><span class="line">      - ~&#x2F;dbs&#x2F;redis:&#x2F;data</span><br><span class="line">networks:</span><br><span class="line">  dbnetwork:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure>

<p>docker-compose up –build 启动后报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Can&#39;t chdir to &#39;&#x2F;usr&#x2F;local&#x2F;var&#x2F;db&#x2F;redis&#x2F;&#39;: No such file or directory</span><br></pre></td></tr></table></figure>

<p>该错误有一个已关闭的<a href="https://github.com/docker-library/redis/issues/93" target="_blank" rel="noopener">git issue</a>给出了解决方案，即手动创建这个不存在的文件夹。</p>
<p>重新修改 Dockerfile 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM redis</span><br><span class="line">COPY redis.conf &#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis&#x2F;redis.conf</span><br><span class="line">RUN mkdir -p &#x2F;usr&#x2F;local&#x2F;var&#x2F;db&#x2F;redis</span><br><span class="line">CMD [ &quot;redis-server&quot;, &quot;&#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis&#x2F;redis.conf&quot; ]</span><br></pre></td></tr></table></figure>

<p>docker-compose up –build，启动成功，使用 redis-cli -a 123456 连接，并执行 get a，测试成功。</p>
<h5 id="gitlab-使用外置redis"><a href="#gitlab-使用外置redis" class="headerlink" title="gitlab 使用外置redis"></a>gitlab 使用外置redis</h5><p>修改docker-compose.yml文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3&#39;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  gitlab:</span><br><span class="line">    container_name: gitlab</span><br><span class="line">    image: gitlab&#x2F;gitlab-ce</span><br><span class="line">    hostname: gitlab</span><br><span class="line">    #restart: always</span><br><span class="line">    networks:</span><br><span class="line">      - default</span><br><span class="line">      - dbnetwork</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8443:443&quot;</span><br><span class="line">      - &quot;8989:8989&quot;</span><br><span class="line">      - &quot;10022:22&quot;</span><br><span class="line">    environment:</span><br><span class="line">      GITLAB_OMNIBUS_CONFIG: |</span><br><span class="line">        external_url &#39;http:&#x2F;&#x2F;127.0.0.1:8989&#39;</span><br><span class="line">        postgresql[&#39;enable&#39;] &#x3D; false</span><br><span class="line">        gitlab_rails[&#39;db_adapter&#39;] &#x3D; &#39;postgresql&#39;</span><br><span class="line">        gitlab_rails[&#39;db_encoding&#39;] &#x3D; &#39;utf8&#39;</span><br><span class="line">        gitlab_rails[&#39;db_host&#39;] &#x3D; &#39;postgres&#39;</span><br><span class="line">        gitlab_rails[&#39;db_port&#39;] &#x3D; &#39;5432&#39;</span><br><span class="line">        gitlab_rails[&#39;db_username&#39;] &#x3D; &#39;lyyljs&#39;</span><br><span class="line">        gitlab_rails[&#39;db_password&#39;] &#x3D; &#39;123456&#39;</span><br><span class="line">        gitlab_rails[&#39;db_database&#39;] &#x3D; &quot;gitlabhq&quot;</span><br><span class="line">        redis[&#39;enable&#39;] &#x3D; false</span><br><span class="line">        gitlab_rails[&#39;redis_host&#39;] &#x3D; &#39;redis&#39;</span><br><span class="line">        gitlab_rails[&#39;redis_port&#39;] &#x3D; 6379</span><br><span class="line">        gitlab_rails[&#39;redis_password&#39;] &#x3D; &#39;123456&#39;</span><br><span class="line">        gitlab_rails[&#39;redis_database&#39;] &#x3D; 2</span><br><span class="line"></span><br><span class="line">    volumes:</span><br><span class="line">      - ~&#x2F;dbs&#x2F;gitlab&#x2F;config:&#x2F;etc&#x2F;gitlab</span><br><span class="line">      - ~&#x2F;dbs&#x2F;gitlab&#x2F;logs:&#x2F;var&#x2F;log&#x2F;gitlab</span><br><span class="line">      - ~&#x2F;dbs&#x2F;gitlab&#x2F;data:&#x2F;var&#x2F;opt&#x2F;gitlab</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  dbnetwork:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure>

<p>如果遇到redis持久化错误，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk.</span><br></pre></td></tr></table></figure>

<p>检查redis的compose配置挂载位置是否与redis.conf中持久化存储位置dir配置相同。</p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>访问<a href="http://localhost:8989/，创建root账号，配置好ssh" target="_blank" rel="noopener">http://localhost:8989/，创建root账号，配置好ssh</a> keys后，新建项目gateway。</p>
<p>在本地gateway项目执行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line"></span><br><span class="line">git remote add origin ssh:&#x2F;&#x2F;git@127.0.0.1:10022&#x2F;root&#x2F;gateway.git</span><br><span class="line"></span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line">git commit -m &quot;init&quot;</span><br><span class="line"></span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>

<p>刷新网页即可看见已经提交的文件了。</p>
<h4 id="清理none-image"><a href="#清理none-image" class="headerlink" title="清理none image"></a>清理none image</h4><p>在配置redis时，因为修改Dockerfile文件导致有名称为 none 的image产生，使用 docker rmi $(docker images -f “dangling=true” -q) 命令移除多余的image。 </p>
<hr>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><p><a href="https://hub.docker.com/_/postgres" target="_blank" rel="noopener">docker hub postgres</a></p>
</li>
<li><p><a href="https://hub.docker.com/_/redis" target="_blank" rel="noopener">docker hub redis</a></p>
</li>
<li><p><a href="https://forums.docker.com/t/docker-failing-to-correctly-process-valid-yaml-config/183/3" target="_blank" rel="noopener">docker错误解析yml配置</a></p>
</li>
<li><p><a href="https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/doc/docker/README.md" target="_blank" rel="noopener">gitlab docker readme</a></p>
</li>
<li><p><a href="https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template" target="_blank" rel="noopener">GITLAB_OMNIBUS_CONFIG template</a></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyyljs.site/2019/04/11/%E4%BD%BF%E7%94%A8docker%E6%90%AD%E5%BB%BAgitlab/" data-id="ckaqogbur001e43o63weo3jev" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-服务容错-三-限流" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/09/%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99-%E4%B8%89-%E9%99%90%E6%B5%81/" class="article-date">
  <time datetime="2019-04-09T13:35:00.000Z" itemprop="datePublished">2019-04-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/09/%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99-%E4%B8%89-%E9%99%90%E6%B5%81/">服务容错(三) 限流</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>限流的目的是通过对并发访问/请求进行限速或者一个时间窗口内的的请求进行限速来保护系统，一旦达到限制速率则可以拒绝服务（定向到错误页或告知资源没有了）、排队或等待（比如秒杀、评论、下单）、降级（返回兜底数据或默认数据，如商品详情页库存默认有货）。</p>
<p>一般开发高并发系统常见的限流有：限制总并发数（比如数据库连接池、线程池）、限制瞬时并发数（如nginx的limit_conn模块，用来限制瞬时并发连接数）、限制时间窗口内的平均速率（如Guava的RateLimiter、nginx的limit_req模块，限制每秒的平均速率）；其他还有如限制远程接口调用速率、限制MQ的消费速率。另外还可以根据网络连接数、网络流量、CPU或内存负载等来限流。</p>
<h4 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h4><p>Dubbo关于限速的类在dubbo-rpc-api项目中org.apache.dubbo.rpc.filter包里。(2.7.1)</p>
<h5 id="TPSLimitFilter"><a href="#TPSLimitFilter" class="headerlink" title="TPSLimitFilter"></a>TPSLimitFilter</h5><p>首先看TPSFilterLimiter，TPSFilterLimiter是一个简单的流量流入限制器，作用于服务提供者。当有请求进来时，看是否有容量能继续处理该请求，有则执行请求，否则抛出RpcException。</p>
<p>判断容量流程：</p>
<ol>
<li><p>当前时间是否大于上次容量重置时间+设置的重置时间间隔，是则将容量重置为预设容量，并更新重置时间</p>
</li>
<li><p>如果当前容量大于0，则尝试减去1，成功则放行，否则失败 </p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class TpsLimitFilter implements Filter &#123;</span><br><span class="line">    private final TPSLimiter tpsLimiter &#x3D; new DefaultTPSLimiter();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Result invoke(Invoker&lt;?&gt; invoker, Invocation invocation) throws RpcException &#123;</span><br><span class="line">    	&#x2F;&#x2F; 判断限流器是否允许请求</span><br><span class="line">        if (!tpsLimiter.isAllowable(invoker.getUrl(), invocation)) &#123;</span><br><span class="line">            throw new RpcException(</span><br><span class="line">                    &quot;Failed to invoke service &quot; +</span><br><span class="line">                            invoker.getInterface().getName() +</span><br><span class="line">                            &quot;.&quot; +</span><br><span class="line">                            invocation.getMethodName() +</span><br><span class="line">                            &quot; because exceed max service tps.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return invoker.invoke(invocation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跳转至tpsLimiter.isAllowable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public boolean isAllowable(URL url, Invocation invocation) &#123;</span><br><span class="line">		&#x2F;&#x2F; 获取URL中请求频率限制（数量）</span><br><span class="line">     int rate &#x3D; url.getParameter(Constants.TPS_LIMIT_RATE_KEY, -1);</span><br><span class="line">     &#x2F;&#x2F; 获取URL中请求数量重置时间(单位时间)</span><br><span class="line">     long interval &#x3D; url.getParameter(Constants.TPS_LIMIT_INTERVAL_KEY,</span><br><span class="line">             Constants.DEFAULT_TPS_LIMIT_INTERVAL);</span><br><span class="line">     String serviceKey &#x3D; url.getServiceKey();</span><br><span class="line">     if (rate &gt; 0) &#123;</span><br><span class="line">     	&#x2F;&#x2F; 状态信息，无则新建</span><br><span class="line">         StatItem statItem &#x3D; stats.get(serviceKey);</span><br><span class="line">         if (statItem &#x3D;&#x3D; null) &#123;</span><br><span class="line">             stats.putIfAbsent(serviceKey,</span><br><span class="line">                     new StatItem(serviceKey, rate, interval));</span><br><span class="line">             statItem &#x3D; stats.get(serviceKey);</span><br><span class="line">         &#125;</span><br><span class="line">         return statItem.isAllowable();</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">         StatItem statItem &#x3D; stats.get(serviceKey);</span><br><span class="line">         if (statItem !&#x3D; null) &#123;</span><br><span class="line">             stats.remove(serviceKey);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     return true;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>继续转入statItem.isAllowable()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public boolean isAllowable() &#123;</span><br><span class="line">    long now &#x3D; System.currentTimeMillis();</span><br><span class="line">    &#x2F;&#x2F; 当前时间是否大于上次重置时间+重置时间间隔</span><br><span class="line">    if (now &gt; lastResetTime + interval) &#123;</span><br><span class="line">    	&#x2F;&#x2F; 重置计数，更新重置时间</span><br><span class="line">        token.set(rate);</span><br><span class="line">        lastResetTime &#x3D; now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int value &#x3D; token.get();</span><br><span class="line">    boolean flag &#x3D; false;</span><br><span class="line">    &#x2F;&#x2F; 尝试获取资源</span><br><span class="line">    while (value &gt; 0 &amp;&amp; !flag) &#123;</span><br><span class="line">        flag &#x3D; token.compareAndSet(value, value - 1);</span><br><span class="line">        value &#x3D; token.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ExecuteLimitFilter"><a href="#ExecuteLimitFilter" class="headerlink" title="ExecuteLimitFilter"></a>ExecuteLimitFilter</h5><p>ExecuteLimitFilter是一个限制同时执行数的限制器，同TPSLimitFilter相同作用于服务提供者。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public class ExecuteLimitFilter implements Filter &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Result invoke(Invoker&lt;?&gt; invoker, Invocation invocation) throws RpcException &#123;</span><br><span class="line">        URL url &#x3D; invoker.getUrl();</span><br><span class="line">        String methodName &#x3D; invocation.getMethodName();</span><br><span class="line">        &#x2F;&#x2F; 获取最大并发执行数</span><br><span class="line">        int max &#x3D; url.getMethodParameter(methodName, Constants.EXECUTES_KEY, 0);</span><br><span class="line">        &#x2F;&#x2F; RpcStatus中保存了调用的一些信息，如当前执行数，执行总次数，失败次数等</span><br><span class="line">        &#x2F;&#x2F; beginCount方法尝试增加method的active即当前执行数，如果原子增加后大于max则减去并返回false，否则成功，且增加URL的active</span><br><span class="line">        if (!RpcStatus.beginCount(url, methodName, max)) &#123;</span><br><span class="line">            throw new RpcException(&quot;Failed to invoke method &quot; + invocation.getMethodName() + &quot; in provider &quot; +</span><br><span class="line">                    url + &quot;, cause: The service using threads greater than &lt;dubbo:service executes&#x3D;\&quot;&quot; + max +</span><br><span class="line">                    &quot;\&quot; &#x2F;&gt; limited.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 成功获取容量，继续执行</span><br><span class="line">        long begin &#x3D; System.currentTimeMillis();</span><br><span class="line">        boolean isSuccess &#x3D; true;</span><br><span class="line">        try &#123;</span><br><span class="line">            return invoker.invoke(invocation);</span><br><span class="line">        &#125; catch (Throwable t) &#123;</span><br><span class="line">            isSuccess &#x3D; false;</span><br><span class="line">            if (t instanceof RuntimeException) &#123;</span><br><span class="line">                throw (RuntimeException) t;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                throw new RpcException(&quot;unexpected exception when ExecuteLimitFilter&quot;, t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">        	&#x2F;&#x2F; 释放资源，减去active，并对URL和method进行统计</span><br><span class="line">            RpcStatus.endCount(url, methodName, System.currentTimeMillis() - begin, isSuccess);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ActiveLimitFilter"><a href="#ActiveLimitFilter" class="headerlink" title="ActiveLimitFilter"></a>ActiveLimitFilter</h5><p>ActiveLimitFilter是一个限制并发执行数（或占用连接的请求数）的限制器。有别于上面两个限制器，该限制器作用于消费端。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">public Result invoke(Invoker&lt;?&gt; invoker, Invocation invocation) throws RpcException &#123;</span><br><span class="line">    URL url &#x3D; invoker.getUrl();</span><br><span class="line">    String methodName &#x3D; invocation.getMethodName();</span><br><span class="line">    &#x2F;&#x2F; 获取最大活跃数</span><br><span class="line">    int max &#x3D; invoker.getUrl().getMethodParameter(methodName, Constants.ACTIVES_KEY, 0);</span><br><span class="line">    &#x2F;&#x2F; 根据url和method获取状态信息</span><br><span class="line">    RpcStatus count &#x3D; RpcStatus.getStatus(invoker.getUrl(), invocation.getMethodName());</span><br><span class="line">    &#x2F;&#x2F; 同ExecuteLimitFilter，尝试获取资源</span><br><span class="line">    if (!count.beginCount(url, methodName, max)) &#123;</span><br><span class="line">    	&#x2F;&#x2F; 获取失败</span><br><span class="line">        long timeout &#x3D; invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.TIMEOUT_KEY, 0);</span><br><span class="line">        long start &#x3D; System.currentTimeMillis();</span><br><span class="line">        &#x2F;&#x2F; 超时剩余时间</span><br><span class="line">        long remain &#x3D; timeout;</span><br><span class="line">        synchronized (count) &#123;</span><br><span class="line">        	&#x2F;&#x2F; 重复尝试获取资源，如获取失败则释放锁并进行等待</span><br><span class="line">            &#x2F;&#x2F; 如果因资源释放被唤醒，则竞争资源</span><br><span class="line">            &#x2F;&#x2F; 或因超时被唤醒</span><br><span class="line">            &#x2F;&#x2F; 在时间耗尽后，则抛出错误</span><br><span class="line">            while (!count.beginCount(url, methodName, max)) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    count.wait(remain);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    &#x2F;&#x2F; ignore</span><br><span class="line">                &#125;</span><br><span class="line">                long elapsed &#x3D; System.currentTimeMillis() - start;</span><br><span class="line">                remain &#x3D; timeout - elapsed;</span><br><span class="line">                if (remain &lt;&#x3D; 0) &#123;</span><br><span class="line">                    throw new RpcException(&quot;Waiting concurrent invoke timeout in client-side for service:  &quot;</span><br><span class="line">                            + invoker.getInterface().getName() + &quot;, method: &quot;</span><br><span class="line">                            + invocation.getMethodName() + &quot;, elapsed: &quot; + elapsed</span><br><span class="line">                            + &quot;, timeout: &quot; + timeout + &quot;. concurrent invokes: &quot; + count.getActive()</span><br><span class="line">                            + &quot;. max concurrent invoke limit: &quot; + max);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 获取资源成功</span><br><span class="line">    boolean isSuccess &#x3D; true;</span><br><span class="line">    long begin &#x3D; System.currentTimeMillis();</span><br><span class="line">    try &#123;</span><br><span class="line">        return invoker.invoke(invocation);</span><br><span class="line">    &#125; catch (RuntimeException t) &#123;</span><br><span class="line">        isSuccess &#x3D; false;</span><br><span class="line">        throw t;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">    	&#x2F;&#x2F; 释放资源，并通知其他等待资源的线程</span><br><span class="line">        count.endCount(url, methodName, System.currentTimeMillis() - begin, isSuccess);</span><br><span class="line">        if (max &gt; 0) &#123;</span><br><span class="line">            synchronized (count) &#123;</span><br><span class="line">                count.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Spring-Cloud-Gateway"><a href="#Spring-Cloud-Gateway" class="headerlink" title="Spring Cloud Gateway"></a>Spring Cloud Gateway</h4><p>在之前的实践有提及spring cloud gateway的限流，现在来看看其实现。(版本2.1.1)</p>
<p>其代码在spring-cloud-gateway-core下的 org.springframework.cloud.gateway.filter.ratelimit 包中。</p>
<p>查看 RedisRateLimiter 类的 isAllowed 方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public Mono&lt;Response&gt; isAllowed(String routeId, String id) &#123;</span><br><span class="line">   	&#x2F;&#x2F; 检查组件是否初始化成功</span><br><span class="line">	if (!this.initialized.get()) &#123;</span><br><span class="line">		throw new IllegalStateException(&quot;RedisRateLimiter is not initialized&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Config routeConfig &#x3D; loadConfiguration(routeId);</span><br><span class="line"></span><br><span class="line">       &#x2F;&#x2F; 允许用户每秒处理多少个请求;令牌桶的填充速率。</span><br><span class="line">	int replenishRate &#x3D; routeConfig.getReplenishRate();</span><br><span class="line"></span><br><span class="line">       &#x2F;&#x2F; 令牌桶的容量，允许在一秒钟内的最大请求数</span><br><span class="line">	int burstCapacity &#x3D; routeConfig.getBurstCapacity();</span><br><span class="line"></span><br><span class="line">	try &#123;</span><br><span class="line">       	&#x2F;&#x2F; 获取redis keys, 包括一个tokenKey和一个timestampKey</span><br><span class="line">		List&lt;String&gt; keys &#x3D; getKeys(id);</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; The arguments to the LUA script. time() returns unixtime in seconds.</span><br><span class="line">           &#x2F;&#x2F; 生成用于执行LUA脚本的参数</span><br><span class="line">           &#x2F;&#x2F; 1. replenishRate, 2. burstCapacity</span><br><span class="line">           &#x2F;&#x2F; 3. 当前时间戳, 4. 请求数 这里恒为1</span><br><span class="line">		List&lt;String&gt; scriptArgs &#x3D; Arrays.asList(replenishRate + &quot;&quot;,</span><br><span class="line">				burstCapacity + &quot;&quot;, Instant.now().getEpochSecond() + &quot;&quot;, &quot;1&quot;);</span><br><span class="line">           &#x2F;&#x2F; Lua脚本返回参数：允许的请求数，剩下的令牌数</span><br><span class="line">		Flux&lt;List&lt;Long&gt;&gt; flux &#x3D; this.redisTemplate.execute(this.script, keys,</span><br><span class="line">				scriptArgs);</span><br><span class="line">                   </span><br><span class="line">           &#x2F;&#x2F; 失败处理，进行记录，将结果写入Header回应</span><br><span class="line">           </span><br><span class="line">		return flux.onErrorResume(throwable -&gt; Flux.just(Arrays.asList(1L, -1L)))</span><br><span class="line">				.reduce(new ArrayList&lt;Long&gt;(), (longs, l) -&gt; &#123;</span><br><span class="line">					longs.addAll(l);</span><br><span class="line">					return longs;</span><br><span class="line">				&#125;).map(results -&gt; &#123;</span><br><span class="line">					boolean allowed &#x3D; results.get(0) &#x3D;&#x3D; 1L;</span><br><span class="line">					Long tokensLeft &#x3D; results.get(1);</span><br><span class="line"></span><br><span class="line">					Response response &#x3D; new Response(allowed,</span><br><span class="line">							getHeaders(routeConfig, tokensLeft));</span><br><span class="line"></span><br><span class="line">					if (log.isDebugEnabled()) &#123;</span><br><span class="line">						log.debug(&quot;response: &quot; + response);</span><br><span class="line">					&#125;</span><br><span class="line">					return response;</span><br><span class="line">				&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	catch (Exception e) &#123;</span><br><span class="line">		log.error(&quot;Error determining if user allowed from redis&quot;, e);</span><br><span class="line">	&#125;</span><br><span class="line">	return Mono.just(new Response(true, getHeaders(routeConfig, -1L)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来查看lua脚本，位于同一项目下resources/META-INF/scripts下。</p>
<p>关键字为 1.tokenKey 和 2.timestampKey</p>
<p>脚本入参依次为：1. replenishRate（令牌填充速率） 2. burstCapacity（最大请求数） 3. 当前时间戳, 4. 请求数 这里恒为1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">local tokens_key &#x3D; KEYS[1]</span><br><span class="line">local timestamp_key &#x3D; KEYS[2]</span><br><span class="line"></span><br><span class="line">local rate &#x3D; tonumber(ARGV[1])</span><br><span class="line">local capacity &#x3D; tonumber(ARGV[2])</span><br><span class="line">local now &#x3D; tonumber(ARGV[3])</span><br><span class="line">local requested &#x3D; tonumber(ARGV[4])</span><br><span class="line"></span><br><span class="line">-- 每次填充时间</span><br><span class="line">local fill_time &#x3D; capacity&#x2F;rate</span><br><span class="line">-- 存活时间</span><br><span class="line">local ttl &#x3D; math.floor(fill_time*2)</span><br><span class="line"></span><br><span class="line">-- 从redis获取剩余令牌数</span><br><span class="line">local last_tokens &#x3D; tonumber(redis.call(&quot;get&quot;, tokens_key))</span><br><span class="line">-- 不存在则进行初始化</span><br><span class="line">if last_tokens &#x3D;&#x3D; nil then</span><br><span class="line">  last_tokens &#x3D; capacity</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 从redis获取上次刷新时间</span><br><span class="line">local last_refreshed &#x3D; tonumber(redis.call(&quot;get&quot;, timestamp_key))</span><br><span class="line">if last_refreshed &#x3D;&#x3D; nil then</span><br><span class="line">  last_refreshed &#x3D; 0</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 上次刷新至今经过的时间</span><br><span class="line">local delta &#x3D; math.max(0, now-last_refreshed)</span><br><span class="line">-- 填充token后token数量</span><br><span class="line">local filled_tokens &#x3D; math.min(capacity, last_tokens+(delta*rate))</span><br><span class="line">-- 判断是否能够允许</span><br><span class="line">local allowed &#x3D; filled_tokens &gt;&#x3D; requested</span><br><span class="line">local new_tokens &#x3D; filled_tokens</span><br><span class="line">local allowed_num &#x3D; 0</span><br><span class="line"></span><br><span class="line">-- 如果可行，则减去请求数</span><br><span class="line">if allowed then</span><br><span class="line">  new_tokens &#x3D; filled_tokens - requested</span><br><span class="line">  allowed_num &#x3D; 1</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 结果写入redis</span><br><span class="line">redis.call(&quot;setex&quot;, tokens_key, ttl, new_tokens)</span><br><span class="line">redis.call(&quot;setex&quot;, timestamp_key, ttl, now)</span><br><span class="line"></span><br><span class="line">-- 返回允许数量，剩余token数量</span><br><span class="line">return &#123; allowed_num, new_tokens &#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyyljs.site/2019/04/09/%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99-%E4%B8%89-%E9%99%90%E6%B5%81/" data-id="ckaqogbw9002f43o6cq2t1mus" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/dubbo/" rel="tag">dubbo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring-cloud/" rel="tag">spring cloud</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-spring-cloud实践-八-log" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/08/spring-cloud%E5%AE%9E%E8%B7%B5-%E5%85%AB-log/" class="article-date">
  <time datetime="2019-04-08T15:30:00.000Z" itemprop="datePublished">2019-04-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/08/spring-cloud%E5%AE%9E%E8%B7%B5-%E5%85%AB-log/">spring cloud实践(八) elk</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>当服务扩展后，每次排查问题需要到多台机器查看日志；这是一个非常麻烦的问题，我们需要一个统一查看日志的地方。</p>
<p>ELK是一个日志集中平台，其组成为elastic search，logstash，kibana。其中es作为日志存储，logstatsh作日志收集，kibana作为可视化页面展示。logstash通常和filebeat共同使用，由filebeat收集本地日志再发送到logstash。</p>
<p><img src="/images/cloud/relationship-between-filebeat-and-logstash.png" alt=""></p>
<p>filebeat也可以不经过logstash直接存储到es进行展示。</p>
<h4 id="ELK"><a href="#ELK" class="headerlink" title="ELK"></a>ELK</h4><h5 id="elastic-search"><a href="#elastic-search" class="headerlink" title="elastic search"></a>elastic search</h5><p>在之前一篇博文中，已搭建es，这里稍作修改方便定位es。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3&#39;</span><br><span class="line">services:</span><br><span class="line">  elasticsearch:</span><br><span class="line">    image: docker.elastic.co&#x2F;elasticsearch&#x2F;elasticsearch:6.7.0</span><br><span class="line">    container_name: elasticsearch</span><br><span class="line">    # 增加 hostname</span><br><span class="line">    hostname: elasticsearch</span><br><span class="line">    networks:</span><br><span class="line">      - default</span><br><span class="line">      - elk</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;9300:9300&quot;</span><br><span class="line">      - &quot;9200:9200&quot;</span><br><span class="line">networks:</span><br><span class="line">  elk:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure>

<h5 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h5><p>同样修改kibana的docker-compose.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3&#39;</span><br><span class="line">services:</span><br><span class="line">  kibana:</span><br><span class="line">    image: docker.elastic.co&#x2F;kibana&#x2F;kibana:6.7.0</span><br><span class="line">    container_name: kibana</span><br><span class="line">    # 增加hostname</span><br><span class="line">    hostname: kibana</span><br><span class="line">    networks:</span><br><span class="line">      - default</span><br><span class="line">      - elk</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5601:5601&quot;</span><br><span class="line">    environment:</span><br><span class="line">      SERVER_NAME: localhost</span><br><span class="line">      SERVER_PORT: 5601</span><br><span class="line">      # 使用elasticsearch代替之前的ip</span><br><span class="line">      ELASTICSEARCH_HOSTS: http:&#x2F;&#x2F;elasticsearch:9200</span><br><span class="line">networks:</span><br><span class="line">  elk:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure>

<h5 id="logstash"><a href="#logstash" class="headerlink" title="logstash"></a>logstash</h5><p>docker-compose.yml文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3&#39;</span><br><span class="line">services:</span><br><span class="line">  logstash:</span><br><span class="line">    image: docker.elastic.co&#x2F;logstash&#x2F;logstash:6.7.1</span><br><span class="line">    container_name: logstash</span><br><span class="line">    hostname: logstash</span><br><span class="line">    networks:</span><br><span class="line">      - default</span><br><span class="line">      - elk</span><br><span class="line">    volumes:</span><br><span class="line">      - ~&#x2F;logs:&#x2F;app&#x2F;logs</span><br><span class="line">      - ~&#x2F;otherapps&#x2F;logstash&#x2F;test-pipeline.conf:&#x2F;usr&#x2F;share&#x2F;logstash&#x2F;pipeline&#x2F;test-pipeline.conf</span><br><span class="line">networks:</span><br><span class="line">  elk:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure>

<p>同时配置pipeline：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path &#x3D;&gt; &quot;&#x2F;app&#x2F;logs&#x2F;*.json&quot;</span><br><span class="line">    codec &#x3D;&gt; &quot;json&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;</span><br><span class="line">    codec &#x3D;&gt; rubydebug</span><br><span class="line">  &#125;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts &#x3D;&gt; &quot;elasticsearch:9200&quot;</span><br><span class="line">    index &#x3D;&gt; &quot;logstash&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="json日志"><a href="#json日志" class="headerlink" title="json日志"></a>json日志</h5><p>配置producer和consumer项目，增加json日志输出。</p>
<p>spring boot 默认使用logback进行日志记录，这里则添加相应的logstash encoder。</p>
<ul>
<li>新增依赖</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  		&lt;groupId&gt;net.logstash.logback&lt;&#x2F;groupId&gt;</span><br><span class="line"> 			&lt;artifactId&gt;logstash-logback-encoder&lt;&#x2F;artifactId&gt;</span><br><span class="line">  		&lt;version&gt;5.3&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置logback</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">	&lt;include resource&#x3D;&quot;org&#x2F;springframework&#x2F;boot&#x2F;logging&#x2F;logback&#x2F;defaults.xml&quot;&#x2F;&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;springProperty scope&#x3D;&quot;context&quot; name&#x3D;&quot;springAppName&quot; source&#x3D;&quot;spring.application.name&quot;&#x2F;&gt;</span><br><span class="line">	&lt;!-- Example for logging into the build folder of your project --&gt;</span><br><span class="line">	&lt;property name&#x3D;&quot;LOG_FILE&quot; value&#x3D;&quot;～&#x2F;logs&#x2F;$&#123;springAppName&#125;&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">	&lt;!-- You can override this to have a custom pattern --&gt;</span><br><span class="line">	&lt;property name&#x3D;&quot;CONSOLE_LOG_PATTERN&quot;</span><br><span class="line">			  value&#x3D;&quot;%clr(%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;)&#123;faint&#125; %clr($&#123;LOG_LEVEL_PATTERN:-%5p&#125;) %clr($&#123;PID:- &#125;)&#123;magenta&#125; %clr(---)&#123;faint&#125; %clr([%15.15t])&#123;faint&#125; %clr(%-40.40logger&#123;39&#125;)&#123;cyan&#125; %clr(:)&#123;faint&#125; %m%n$&#123;LOG_EXCEPTION_CONVERSION_WORD:-%wEx&#125;&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">	&lt;!-- Appender to log to console --&gt;</span><br><span class="line">	&lt;appender name&#x3D;&quot;console&quot; class&#x3D;&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;</span><br><span class="line">		&lt;filter class&#x3D;&quot;ch.qos.logback.classic.filter.ThresholdFilter&quot;&gt;</span><br><span class="line">			&lt;!-- Minimum logging level to be presented in the console logs--&gt;</span><br><span class="line">			&lt;level&gt;DEBUG&lt;&#x2F;level&gt;</span><br><span class="line">		&lt;&#x2F;filter&gt;</span><br><span class="line">		&lt;encoder&gt;</span><br><span class="line">			&lt;pattern&gt;$&#123;CONSOLE_LOG_PATTERN&#125;&lt;&#x2F;pattern&gt;</span><br><span class="line">			&lt;charset&gt;utf8&lt;&#x2F;charset&gt;</span><br><span class="line">		&lt;&#x2F;encoder&gt;</span><br><span class="line">	&lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">	&lt;!-- Appender to log to file --&gt;</span><br><span class="line">	&lt;appender name&#x3D;&quot;flatfile&quot; class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">		&lt;file&gt;$&#123;LOG_FILE&#125;&lt;&#x2F;file&gt;</span><br><span class="line">		&lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">			&lt;fileNamePattern&gt;$&#123;LOG_FILE&#125;.%d&#123;yyyy-MM-dd&#125;.gz&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">			&lt;maxHistory&gt;7&lt;&#x2F;maxHistory&gt;</span><br><span class="line">		&lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">		&lt;encoder&gt;</span><br><span class="line">			&lt;pattern&gt;$&#123;CONSOLE_LOG_PATTERN&#125;&lt;&#x2F;pattern&gt;</span><br><span class="line">			&lt;charset&gt;utf8&lt;&#x2F;charset&gt;</span><br><span class="line">		&lt;&#x2F;encoder&gt;</span><br><span class="line">	&lt;&#x2F;appender&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;!-- Appender to log to file in a JSON format --&gt;</span><br><span class="line">	&lt;appender name&#x3D;&quot;logstash&quot; class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">		&lt;file&gt;$&#123;LOG_FILE&#125;.json&lt;&#x2F;file&gt;</span><br><span class="line">		&lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">			&lt;fileNamePattern&gt;$&#123;LOG_FILE&#125;.json.%d&#123;yyyy-MM-dd&#125;.gz&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">			&lt;maxHistory&gt;7&lt;&#x2F;maxHistory&gt;</span><br><span class="line">		&lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">		&lt;encoder class&#x3D;&quot;net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder&quot;&gt;</span><br><span class="line">			&lt;providers&gt;</span><br><span class="line">				&lt;timestamp&gt;</span><br><span class="line">					&lt;timeZone&gt;UTC&lt;&#x2F;timeZone&gt;</span><br><span class="line">				&lt;&#x2F;timestamp&gt;</span><br><span class="line">				&lt;pattern&gt;</span><br><span class="line">					&lt;pattern&gt;</span><br><span class="line">						&#123;</span><br><span class="line">						&quot;severity&quot;: &quot;%level&quot;,</span><br><span class="line">						&quot;service&quot;: &quot;$&#123;springAppName:-&#125;&quot;,</span><br><span class="line">						&quot;trace&quot;: &quot;%X&#123;X-B3-TraceId:-&#125;&quot;,</span><br><span class="line">						&quot;span&quot;: &quot;%X&#123;X-B3-SpanId:-&#125;&quot;,</span><br><span class="line">						&quot;parent&quot;: &quot;%X&#123;X-B3-ParentSpanId:-&#125;&quot;,</span><br><span class="line">						&quot;exportable&quot;: &quot;%X&#123;X-Span-Export:-&#125;&quot;,</span><br><span class="line">						&quot;pid&quot;: &quot;$&#123;PID:-&#125;&quot;,</span><br><span class="line">						&quot;thread&quot;: &quot;%thread&quot;,</span><br><span class="line">						&quot;class&quot;: &quot;%logger&#123;40&#125;&quot;,</span><br><span class="line">						&quot;rest&quot;: &quot;%message&quot;</span><br><span class="line">						&#125;</span><br><span class="line">					&lt;&#x2F;pattern&gt;</span><br><span class="line">				&lt;&#x2F;pattern&gt;</span><br><span class="line">			&lt;&#x2F;providers&gt;</span><br><span class="line">		&lt;&#x2F;encoder&gt;</span><br><span class="line">	&lt;&#x2F;appender&gt;</span><br><span class="line">	</span><br><span class="line">	&lt;root level&#x3D;&quot;INFO&quot;&gt;</span><br><span class="line">		&lt;appender-ref ref&#x3D;&quot;console&quot;&#x2F;&gt;</span><br><span class="line">		&lt;!-- uncomment this to have also JSON logs --&gt;</span><br><span class="line">		&lt;appender-ref ref&#x3D;&quot;logstash&quot;&#x2F;&gt;</span><br><span class="line">		&lt;appender-ref ref&#x3D;&quot;flatfile&quot;&#x2F;&gt;</span><br><span class="line">	&lt;&#x2F;root&gt;</span><br><span class="line">&lt;&#x2F;configuration&gt;</span><br></pre></td></tr></table></figure>

<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><p>启动测试，在 kibana 的 management中能找到logstash的es index，添加至kibana index，即可查看日志。</p>
<h4 id="ELK-filebeat"><a href="#ELK-filebeat" class="headerlink" title="ELK + filebeat"></a>ELK + filebeat</h4><h5 id="logstatsh"><a href="#logstatsh" class="headerlink" title="logstatsh"></a>logstatsh</h5><p>修改 pipeline.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port &#x3D;&gt; 5045</span><br><span class="line">    type &#x3D;&gt; beats</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;</span><br><span class="line">    codec &#x3D;&gt; rubydebug</span><br><span class="line">  &#125;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts &#x3D;&gt; &quot;elasticsearch:9200&quot;</span><br><span class="line">    index &#x3D;&gt; &quot;logstash&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="filebeat"><a href="#filebeat" class="headerlink" title="filebeat"></a>filebeat</h5><p>docker-compose.yml 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3&#39;</span><br><span class="line">services:</span><br><span class="line">  logstash:</span><br><span class="line">    image: store&#x2F;elastic&#x2F;filebeat:6.7.1</span><br><span class="line">    container_name: filebeat</span><br><span class="line">    networks:</span><br><span class="line">      - default</span><br><span class="line">      - elk</span><br><span class="line">    volumes:</span><br><span class="line">      - ~&#x2F;logs:&#x2F;app&#x2F;logs</span><br><span class="line">      - ~&#x2F;otherapps&#x2F;filebeat&#x2F;filebeat.yml:&#x2F;usr&#x2F;share&#x2F;filebeat&#x2F;filebeat.yml</span><br><span class="line">      - ~&#x2F;otherapps&#x2F;filebeat&#x2F;registry:&#x2F;usr&#x2F;share&#x2F;filebeat&#x2F;registry</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  elk:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure>

<p>filebeat.yml 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">filebeat:</span><br><span class="line">  inputs:</span><br><span class="line">  - type: log</span><br><span class="line">    paths:</span><br><span class="line">      - &#x2F;app&#x2F;logs&#x2F;*.json</span><br><span class="line">  registry_file: &#x2F;usr&#x2F;share&#x2F;filebeat&#x2F;registry&#x2F;mark</span><br><span class="line"></span><br><span class="line">json.keys_under_root: true</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">  logstash:</span><br><span class="line">    hosts: [&quot;logstash:5045&quot;]</span><br><span class="line"></span><br><span class="line">logging:</span><br><span class="line">  files:</span><br><span class="line">    rotateeverybytes: 10485760 # &#x3D; 10MB</span><br></pre></td></tr></table></figure>

<h5 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h5><p>同ELK相同展示。</p>
<h4 id="kibana-log"><a href="#kibana-log" class="headerlink" title="kibana log"></a>kibana log</h4><p>在kibana菜单栏有日志一栏，专门用来展示日志汇总。如需使用则对相关组件做如下修改。</p>
<h5 id="filebeat-1"><a href="#filebeat-1" class="headerlink" title="filebeat"></a>filebeat</h5><p>修改filebeat.yml，需新增模块。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">filebeat:</span><br><span class="line">  inputs:</span><br><span class="line">  - type: log</span><br><span class="line">    paths:</span><br><span class="line">      - &#x2F;app&#x2F;logs&#x2F;*.json</span><br><span class="line">  modules:</span><br><span class="line">  - module: logstash</span><br><span class="line">  registry_file: &#x2F;usr&#x2F;share&#x2F;filebeat&#x2F;registry&#x2F;mark</span><br><span class="line"></span><br><span class="line">json.keys_under_root: true</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">  elasticsearch:</span><br><span class="line">    hosts: [&quot;elasticsearch:9200&quot;]</span><br><span class="line">#  logstash:</span><br><span class="line">#    hosts: [&quot;logstash:5044&quot;]</span><br><span class="line"></span><br><span class="line">setup.kibana:</span><br><span class="line">  host: &quot;kibana:5601&quot;</span><br><span class="line"></span><br><span class="line">logging:</span><br><span class="line">  files:</span><br><span class="line">    rotateeverybytes: 10485760 # &#x3D; 10MB</span><br></pre></td></tr></table></figure>

<h5 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h5><p>启动测试，在 kibana 的 management中能找到filebeat的es index，添加至kibana index，即可查看数据。</p>
<p><img src="/images/cloud/kibana-es-filebeat.png" alt="kibana-es-filebeat"></p>
<p>在logs里可查看日志。</p>
<p><img src="/images/cloud/kibana-logs.png" alt="kibana-logs"></p>
<hr>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><p><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-sleuth/2.1.0.RELEASE/single/spring-cloud-sleuth.html" target="_blank" rel="noopener">spring cloud sleuth文档</a></p>
</li>
<li><p><a href="https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html" target="_blank" rel="noopener">logstash 配置文件结构</a></p>
</li>
<li><p><a href="https://www.elastic.co/guide/en/logstash/current/docker-config.html" target="_blank" rel="noopener">在docker配置logstash</a></p>
</li>
<li><p><a href="https://www.jianshu.com/p/35a397486afc" target="_blank" rel="noopener">Docker ELK实践之Logstash</a></p>
</li>
<li><p><a href="https://blog.csdn.net/wfs1994/article/details/80862225" target="_blank" rel="noopener">Logstash 基础知识整理</a></p>
</li>
<li><p><a href="https://www.cnblogs.com/jicki/p/5913622.html" target="_blank" rel="noopener">docker 容器日志集中 ELK + filebeat</a></p>
</li>
<li><p><a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-log.html" target="_blank" rel="noopener">filebeat-input-log</a></p>
</li>
<li><p><a href="https://www.elastic.co/guide/en/beats/filebeat/current/load-kibana-dashboards.html" target="_blank" rel="noopener">Kibana dashboards</a></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyyljs.site/2019/04/08/spring-cloud%E5%AE%9E%E8%B7%B5-%E5%85%AB-log/" data-id="ckaqogbuh001643o6d90a2w42" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elk/" rel="tag">elk</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring-cloud/" rel="tag">spring cloud</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-spring-cloud实践-七-sleuth" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/08/spring-cloud%E5%AE%9E%E8%B7%B5-%E4%B8%83-sleuth/" class="article-date">
  <time datetime="2019-04-08T10:33:00.000Z" itemprop="datePublished">2019-04-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/08/spring-cloud%E5%AE%9E%E8%B7%B5-%E4%B8%83-sleuth/">spring cloud实践(七) sleuth</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="链路追踪"><a href="#链路追踪" class="headerlink" title="链路追踪"></a>链路追踪</h4><p>随着业务发展，后端服务单元不断增加，导致一个前端请求需要诸多后端服务参与，这也使得如果请求出现问题变慢难以定位原因。此时就需要链路追踪系统。</p>
<p>分布式链路追踪系统会跟进一个请求到底有哪些服务参与，参与的顺序又是怎样的，从而达到每个请求的步骤清晰可见，出了问题，很快定位。</p>
<p>一般地，一个分布式链路追踪系统分为三个部分：数据收集，数据存储和数据展示。</p>
<h4 id="spring-cloud-sleuth"><a href="#spring-cloud-sleuth" class="headerlink" title="spring cloud sleuth"></a>spring cloud sleuth</h4><p>spring cloud sleuth 是 spring cloud 的分布式链路追踪解决方案的实现。</p>
<h5 id="基本术语"><a href="#基本术语" class="headerlink" title="基本术语"></a>基本术语</h5><p>Spring Cloud Sleuth采用的是Google的开源项目<a href="https://ai.google/research/pubs/pub36356" target="_blank" rel="noopener">Dapper</a>的专业术语。</p>
<ul>
<li><p><strong>Span</strong>: 基本工作单元，发送一个远程调度任务 就会产生一个Span，Span是一个64位ID唯一标识的，Trace是用另一个64位ID唯一标识的，Span还有其他数据信息，比如摘要、时间戳事件、Span的ID、以及进度ID。</p>
</li>
<li><p><strong>Trace</strong>: 一系列Span组成的一个树状结构。请求一个微服务系统的API接口，这个API接口，需要调用多个微服务，调用每个微服务都会产生一个新的Span，所有由这个请求产生的Span组成了这个Trace。</p>
</li>
<li><p><strong>Annotation</strong>: 用来及时记录一个事件的，一些核心注解用来定义一个请求的开始和结束。在sleuth使用了<a href="https://github.com/openzipkin/brave" target="_blank" rel="noopener">Brave</a>以后，已不需要使用这些特定事件来让zipkin理解是client或server，事件的开始以及结束。但为了学习的目的，仍然将这些行为标注出来。这些注解包括以下：</p>
<ul>
<li>cs: Client Sent，客户端发送一个请求，这个注解描述了这个Span的开始</li>
<li>sr: Server Received，服务端获得请求并准备开始处理它，如果将其sr减去cs时间戳便可得到网络传输的时间。</li>
<li>ss: Server Sent，服务端发送响应，该注解表明请求处理的完成(当请求返回客户端)，如果ss的时间戳减去sr时间戳，就可以得到服务器请求的时间。</li>
<li>cr: Client Received，客户端接收响应，此时Span的结束，如果cr的时间戳减去cs时间戳便可以得到整个请求所消耗的时间。</li>
</ul>
</li>
</ul>
<p>下图展示了工作图：<br><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-sleuth/master/docs/src/main/asciidoc/images/trace-id.png" alt="Sleuth Working"></p>
<h4 id="zipkin"><a href="#zipkin" class="headerlink" title="zipkin"></a>zipkin</h4><p>Zipkin 是一个开放源代码分布式的跟踪系统，由Twitter公司开源，它致力于收集服务的定时数据，以解决微服务架构中的延迟问题，包括数据的收集、存储、查找和展现。</p>
<p>每个服务向zipkin报告计时数据，zipkin会根据调用关系通过Zipkin UI生成依赖关系图，显示了多少跟踪请求通过每个服务，该系统让开发者可通过一个 Web 前端轻松的收集和分析数据，例如用户每次请求服务的处理时间等，可方便的监测系统中存在的瓶颈。</p>
<p>Zipkin提供了可插拔数据存储方式：In-Memory、MySql、Cassandra以及Elasticsearch。接下来的测试为方便直接采用In-Memory方式进行存储，生产推荐Elasticsearch。</p>
<h4 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h4><h5 id="搭建zipkin-server"><a href="#搭建zipkin-server" class="headerlink" title="搭建zipkin server"></a>搭建zipkin server</h5><p>新建zipkin server项目,zipkin 可以使用 http,rabbitmq 等方式来进行数据交换，这里采用rabbitmq的方式。在持久化方面可使用 mysql,elasticsearch 等方式，这里采用elasticsearch。</p>
<ul>
<li>添加依赖</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">&lt;parent&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-boot-starter-parent&lt;&#x2F;artifactId&gt;</span><br><span class="line">	&lt;version&gt;2.1.4.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">	&lt;relativePath&#x2F;&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">&lt;&#x2F;parent&gt;</span><br><span class="line">&lt;groupId&gt;lyyljs.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">&lt;artifactId&gt;zipkinserver&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;version&gt;0.0.1-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">&lt;name&gt;zipkinserver&lt;&#x2F;name&gt;</span><br><span class="line">&lt;description&gt;Demo project for Spring Boot&lt;&#x2F;description&gt;</span><br><span class="line"></span><br><span class="line">&lt;properties&gt;</span><br><span class="line">	&lt;java.version&gt;1.8&lt;&#x2F;java.version&gt;</span><br><span class="line">	&lt;spring-cloud.version&gt;Greenwich.RELEASE&lt;&#x2F;spring-cloud.version&gt;</span><br><span class="line">	&lt;zipkin.version&gt;2.12.8&lt;&#x2F;zipkin.version&gt;</span><br><span class="line">&lt;&#x2F;properties&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">		&lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">	&lt;&#x2F;dependency&gt;</span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">   		&lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">   		&lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;&#x2F;artifactId&gt;</span><br><span class="line">	&lt;&#x2F;dependency&gt;</span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">   		&lt;groupId&gt;io.zipkin.java&lt;&#x2F;groupId&gt;</span><br><span class="line">   		&lt;artifactId&gt;zipkin-server&lt;&#x2F;artifactId&gt;</span><br><span class="line">   		&lt;version&gt;$&#123;zipkin.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">	&lt;&#x2F;dependency&gt;</span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">   		&lt;groupId&gt;io.zipkin.java&lt;&#x2F;groupId&gt;</span><br><span class="line">   		&lt;artifactId&gt;zipkin-autoconfigure-ui&lt;&#x2F;artifactId&gt;</span><br><span class="line">   		&lt;version&gt;$&#123;zipkin.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">	&lt;&#x2F;dependency&gt;</span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;io.zipkin.java&lt;&#x2F;groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;zipkin-autoconfigure-collector-rabbitmq&lt;&#x2F;artifactId&gt;</span><br><span class="line">           &lt;version&gt;$&#123;zipkin.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">       &lt;&#x2F;dependency&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">		&lt;groupId&gt;io.zipkin.java&lt;&#x2F;groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;zipkin-autoconfigure-storage-elasticsearch&lt;&#x2F;artifactId&gt;</span><br><span class="line">		&lt;version&gt;$&#123;zipkin.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">	&lt;&#x2F;dependency&gt;</span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">   		&lt;groupId&gt;org.springframework.amqp&lt;&#x2F;groupId&gt;</span><br><span class="line">   		&lt;artifactId&gt;spring-rabbit&lt;&#x2F;artifactId&gt;</span><br><span class="line">	&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">		&lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">		&lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">	&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">	&lt;dependencies&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-dependencies&lt;&#x2F;artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;spring-cloud.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">			&lt;type&gt;pom&lt;&#x2F;type&gt;</span><br><span class="line">			&lt;scope&gt;import&lt;&#x2F;scope&gt;</span><br><span class="line">		&lt;&#x2F;dependency&gt;</span><br><span class="line">	&lt;&#x2F;dependencies&gt;</span><br><span class="line">&lt;&#x2F;dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">&lt;build&gt;</span><br><span class="line">	&lt;plugins&gt;</span><br><span class="line">		&lt;plugin&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">		&lt;&#x2F;plugin&gt;</span><br><span class="line">	&lt;&#x2F;plugins&gt;</span><br><span class="line">&lt;&#x2F;build&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>添加配置application.yml</li>
</ul>
<p>zipkin server 采用了 armeria 作为web容器，所以这里需要将默认的web容器监听端口关闭，并对配置 armeria。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">   port: -1</span><br><span class="line">   register:</span><br><span class="line">    port1: 8000</span><br><span class="line">    port2: 8001</span><br><span class="line">    port3: 8002</span><br><span class="line"></span><br><span class="line">armeria:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 9411</span><br><span class="line">      protocol: HTTP</span><br><span class="line"></span><br><span class="line">zipkin:</span><br><span class="line">  storage:</span><br><span class="line">    StorageComponent: elasticsearch</span><br><span class="line">    type: elasticsearch</span><br><span class="line">    elasticsearch:</span><br><span class="line">      hosts: localhost:9200</span><br><span class="line">  collector:</span><br><span class="line">    rabbitmq:</span><br><span class="line">      addresses: localhost:5672</span><br><span class="line">      username: guest</span><br><span class="line">      password: guest</span><br><span class="line">      queue: zipkin</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: spring-cloud-zipkin-server</span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: localhost</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http:&#x2F;&#x2F;$&#123;eureka.instance.hostname&#125;:$&#123;server.register.port1&#125;&#x2F;eureka&#x2F;</span><br></pre></td></tr></table></figure>

<ul>
<li>为启动类添加注解</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableEurekaClient</span><br><span class="line">@EnableZipkinServer</span><br><span class="line">public class ZipkinserverApplication &#123;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动</li>
</ul>
<p>访问 <a href="http://localhost:9411/zipkin" target="_blank" rel="noopener">http://localhost:9411/zipkin</a> 进入可视化页面。</p>
<h5 id="为producer添加追踪组件"><a href="#为producer添加追踪组件" class="headerlink" title="为producer添加追踪组件"></a>为producer添加追踪组件</h5><ul>
<li>添加依赖</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  		&lt;groupId&gt;org.springframework.amqp&lt;&#x2F;groupId&gt;</span><br><span class="line">  		&lt;artifactId&gt;spring-rabbit&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  		&lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">  		&lt;artifactId&gt;spring-cloud-starter-zipkin&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>添加配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: spring-cloud-producer</span><br><span class="line">  zipkin:</span><br><span class="line">    #base-url: http:&#x2F;&#x2F;localhost:9411</span><br><span class="line">     sender:</span><br><span class="line">       type: rabbit</span><br><span class="line">  sleuth:</span><br><span class="line">    messaging:</span><br><span class="line">      rabbit:</span><br><span class="line">       enabled: true</span><br><span class="line">    sampler:</span><br><span class="line">      #应采样的请求的概率。 例如。 应该对1.0  -  100％的请求进行抽样。 精度仅为整数（即不支持0.1％的迹线）。</span><br><span class="line">      probability: 1.0</span><br><span class="line">  rabbitmq:</span><br><span class="line">    host: localhost</span><br><span class="line">    port: 5672</span><br><span class="line">    username: guest</span><br><span class="line">    password: guest</span><br></pre></td></tr></table></figure>

<h5 id="为consumer添加追踪组件"><a href="#为consumer添加追踪组件" class="headerlink" title="为consumer添加追踪组件"></a>为consumer添加追踪组件</h5><p>同producer相同</p>
<ul>
<li>添加依赖</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  		&lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">  		&lt;artifactId&gt;spring-cloud-starter-zipkin&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  		&lt;groupId&gt;org.springframework.amqp&lt;&#x2F;groupId&gt;</span><br><span class="line">  		&lt;artifactId&gt;spring-rabbit&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>添加配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: spring-cloud-consumer</span><br><span class="line">  zipkin:</span><br><span class="line">    #base-url: http:&#x2F;&#x2F;localhost:9411</span><br><span class="line">    sender:</span><br><span class="line">      type: rabbit</span><br><span class="line">  sleuth:</span><br><span class="line">    messaging:</span><br><span class="line">      rabbit:</span><br><span class="line">       enabled: true</span><br><span class="line">    sampler:</span><br><span class="line">      #应采样的请求的概率。 例如。 应该对1.0  -  100％的请求进行抽样。 精度仅为整数（即不支持0.1％的迹线）。</span><br><span class="line">      probability: 1.0</span><br><span class="line">  rabbitmq:</span><br><span class="line">    host: localhost</span><br><span class="line">    port: 5672</span><br><span class="line">    username: guest</span><br><span class="line">    password: guest</span><br></pre></td></tr></table></figure>

<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><p>访问 <a href="http://localhost:9001/hello/lyyljs" target="_blank" rel="noopener">http://localhost:9001/hello/lyyljs</a>, 然后在zipkin server可视化页面查看</p>
<p>路径追踪:<br><img src="/images/cloud/traces.png" alt="traces"></p>
<p>可点击进入trace详情<br><img src="/images/cloud/trace.png" alt="trace"></p>
<p>依赖分析:<br><img src="/images/cloud/dependencies.png" alt="dependencies"></p>
<p>可点击服务查看详情:</p>
<p><img src="/images/cloud/dependency1.png" alt="dependencies"></p>
<p><img src="/images/cloud/dependency2.png" alt="dependencies"></p>
<p>在kibana建立index:</p>
<p><img src="/images/cloud/kibana-zipkin-index.png" alt="kibana"></p>
<p>在kibana查看elasticsearch的数据:</p>
<p><img src="/images/cloud/kibana-zipkin-discover.png" alt="kibana"></p>
<hr>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><p><a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-sleuth/2.1.0.RELEASE/single/spring-cloud-sleuth.html" target="_blank" rel="noopener">spring cloud sleuth官方文档</a></p>
</li>
<li><p><a href="https://github.com/openzipkin/zipkin" target="_blank" rel="noopener">zipkin github</a></p>
</li>
<li><p><a href="https://line.github.io/armeria/" target="_blank" rel="noopener">armeria官方文档</a></p>
</li>
<li><p><a href="https://github.com/line/armeria-examples" target="_blank" rel="noopener">armeria-examples</a></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyyljs.site/2019/04/08/spring-cloud%E5%AE%9E%E8%B7%B5-%E4%B8%83-sleuth/" data-id="ckaqogbuk001943o6f9b62sv5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring-cloud/" rel="tag">spring cloud</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-使用docker搭建elasticsearch和kibana" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/06/%E4%BD%BF%E7%94%A8docker%E6%90%AD%E5%BB%BAelasticsearch%E5%92%8Ckibana/" class="article-date">
  <time datetime="2019-04-06T11:20:00.000Z" itemprop="datePublished">2019-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/06/%E4%BD%BF%E7%94%A8docker%E6%90%AD%E5%BB%BAelasticsearch%E5%92%8Ckibana/">使用docker搭建elasticsearch和kibana</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><h5 id="创建docker-network"><a href="#创建docker-network" class="headerlink" title="创建docker network"></a>创建docker network</h5><p>创建一个docker network用于docker 应用间的互通。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create elk</span><br></pre></td></tr></table></figure>

<p>上面 elk 是创建网络的名称。</p>
<p>然后可以是用以下命令查看创建网络的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect elk</span><br></pre></td></tr></table></figure>

<h4 id="创建elasticsearch应用"><a href="#创建elasticsearch应用" class="headerlink" title="创建elasticsearch应用"></a>创建elasticsearch应用</h4><p>使用docker-compose来编排elasticsearch应用，其yml文件如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3&#39;</span><br><span class="line">services:</span><br><span class="line">  elasticsearch:</span><br><span class="line">    image: docker.elastic.co&#x2F;elasticsearch&#x2F;elasticsearch:6.7.0</span><br><span class="line">    container_name: elasticsearch</span><br><span class="line">    networks:</span><br><span class="line">      - default</span><br><span class="line">      - elk</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;9300:9300&quot;</span><br><span class="line">      - &quot;9200:9200&quot;</span><br><span class="line">    environment:</span><br><span class="line">      - discovery.type&#x3D;single-node</span><br><span class="line">networks:</span><br><span class="line">  elk:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure>

<p>然后执行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up</span><br></pre></td></tr></table></figure>

<p>使用以下命令验证是否已正常启动es</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl &#39;http:&#x2F;&#x2F;localhost:9200&#x2F;?pretty&#39;</span><br></pre></td></tr></table></figure>

<h4 id="创建kibana应用"><a href="#创建kibana应用" class="headerlink" title="创建kibana应用"></a>创建kibana应用</h4><p>同样使用docker-compose来创建kibana应用，yml文件如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;3&#39;</span><br><span class="line">services:</span><br><span class="line">  kibana:</span><br><span class="line">    image: docker.elastic.co&#x2F;kibana&#x2F;kibana:6.7.0</span><br><span class="line">    container_name: kibana</span><br><span class="line">    networks:</span><br><span class="line">      - default</span><br><span class="line">      - elk</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5601:5601&quot;</span><br><span class="line">    environment:</span><br><span class="line">      SERVER_NAME: localhost</span><br><span class="line">      SERVER_PORT: 5601</span><br><span class="line">      ELASTICSEARCH_HOSTS: http:&#x2F;&#x2F;172.20.0.2:9200</span><br><span class="line">networks:</span><br><span class="line">  elk:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure>

<p>其中 ELASTICSEARCH_HOSTS 的地址是由 docker network 获得。</p>
<p>然后通过 docker-compose up 启动应用。</p>
<p>访问 <a href="http://localhost:5601" target="_blank" rel="noopener">http://localhost:5601</a> 进入kibana页面。</p>
<h4 id="额外"><a href="#额外" class="headerlink" title="额外"></a>额外</h4><p>使用 docker network inspect elk 可查看当前网络信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">  docker network inspect elk</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;elk&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;a5435f367fbd68104c8f4cd52556933bf70bbd41afdea600598d29d233668583&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2019-04-06T02:43:00.6431085Z&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;172.20.0.0&#x2F;16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.20.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;62aa6a65e845cf6cb1b0f5fa3a73483b9305eb65d07de33c6c6ace8008bf53b0&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;elasticsearch&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;267b8af789689db8d65b5f6f64b7b4da3dc418e39f02dc7f9d0c918c9f598169&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:14:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.20.0.2&#x2F;16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;6774e69500f19b898406b856f1a0ad2a1bce0b22c18e786d5e1d2752b253b42d&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;kibana&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;c567c8230161b5dd8b2c6bf2d23261340d67e748c3f64fd630e3d5385cba32e0&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:14:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.20.0.3&#x2F;16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>可以使用ping来测试互通是否成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">⇒  docker exec -it elasticsearch ping kibana</span><br><span class="line">PING kibana (172.20.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from kibana.elk (172.20.0.3): icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.192 ms</span><br><span class="line">64 bytes from kibana.elk (172.20.0.3): icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;0.167 ms</span><br><span class="line">64 bytes from kibana.elk (172.20.0.3): icmp_seq&#x3D;3 ttl&#x3D;64 time&#x3D;0.169 ms</span><br><span class="line">64 bytes from kibana.elk (172.20.0.3): icmp_seq&#x3D;4 ttl&#x3D;64 time&#x3D;0.128 ms</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://www.elastic.co/guide/en/kibana/current/docker.html#bind-mount-config" target="_blank" rel="noopener">Running Kibana on Docker</a></li>
<li><a href="https://www.elastic.co/guide/en/kibana/6.7/settings.html" target="_blank" rel="noopener">Configuring Kibana</a></li>
<li><a href="https://hub.docker.com/_/kibana" target="_blank" rel="noopener">dockerhub kibana</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lyyljs.site/2019/04/06/%E4%BD%BF%E7%94%A8docker%E6%90%AD%E5%BB%BAelasticsearch%E5%92%8Ckibana/" data-id="ckaqogbuu001l43o6csp5bmg8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elastic-search/" rel="tag">elastic search</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dubbo/" rel="tag">dubbo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elastic-search/" rel="tag">elastic search</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elk/" rel="tag">elk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java%E5%91%BD%E4%BB%A4/" rel="tag">java命令</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java%E5%9F%BA%E7%A1%80/" rel="tag">java基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-cloud/" rel="tag">spring cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stream/" rel="tag">stream</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/dubbo/" style="font-size: 15px;">dubbo</a> <a href="/tags/elastic-search/" style="font-size: 10px;">elastic search</a> <a href="/tags/elk/" style="font-size: 10px;">elk</a> <a href="/tags/java/" style="font-size: 12.5px;">java</a> <a href="/tags/java%E5%91%BD%E4%BB%A4/" style="font-size: 17.5px;">java命令</a> <a href="/tags/java%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">java基础</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/spring-cloud/" style="font-size: 20px;">spring cloud</a> <a href="/tags/stream/" style="font-size: 10px;">stream</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/06/05/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%A7%A3%E5%86%B3%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%B8%9A%E5%8A%A1%E5%9F%9F%E5%90%8D%E9%99%90%E5%88%B6%E9%97%AE%E9%A2%98/">反向代理解决微信小程序业务域名限制问题</a>
          </li>
        
          <li>
            <a href="/2019/05/13/Stream-%E7%BC%96%E7%A8%8B%E8%83%8C%E5%90%8E/">Stream实现原理</a>
          </li>
        
          <li>
            <a href="/2019/05/04/jdk8%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/">jdk8函数式编程</a>
          </li>
        
          <li>
            <a href="/2019/04/27/OWASP%E7%AC%AC%E4%B8%89%E6%96%B9%E4%BE%9D%E8%B5%96%E6%A3%80%E6%9F%A5%E6%8F%92%E4%BB%B6%E4%BD%BF%E7%94%A8/">OWASP第三方依赖检查插件使用</a>
          </li>
        
          <li>
            <a href="/2019/04/11/docker%E6%90%AD%E5%BB%BAjenkins/">docker搭建jenkins</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 lyyljs<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>